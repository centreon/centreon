name: plugin-packs

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/plugin-packs.yml'
      - 'plugin-packs/**'
  push:
    branches:
      - develop
    paths:
      - '.github/workflows/plugin-packs.yml'
      - 'plugin-packs/**'
    tags:
      - plugin-packs-22.10.**

env:
  version: "22.10"

jobs:
  plugin-packs-packaging-rpm:
    runs-on: [self-hosted, common]

    strategy:
      matrix:
        include:
          - image: packaging-plugin-packs-centos7
            distrib: el7
            path: plugin-packs/redhat
          - image: packaging-plugin-packs-alma8
            distrib: el8
            path: plugin-packs/redhat

    steps:
      - name: Checkout sources
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: 'Get minor and release version'
        uses: ./.github/actions/get-package-version
        with:
          module_name: ${{ env.module }}
        id: get_version

      - name: Login to Registry
        uses: docker/login-action@v2
        with:
          registry: docker.registry.apps.centreon.com
          username: ${{ secrets.NEXUS_RPMS_REPOSITORY_USERNAME }}
          password: ${{ secrets.NEXUS_RPMS_REPOSITORY_PASSWORD }}

      - name: Package
        uses: ./.github/actions/runner-docker
        with:
          script_name: ${{ matrix.path }}/plugin-packs-packaging
          image_name: ${{ matrix.image }}
          image_version: ${{ env.version }}
          params: ${{ env.version }}.${{ steps.get_version.outputs.minor_version }} ${{ steps.get_version.outputs.release }}

      - name: Sign
        uses: ./.github/actions/runner-docker
        with:
          script_name: rpm-signing
          image_name: rpm-signing
          image_version: ubuntu

      - name: Use cache RPM files
        uses: actions/cache@v3
        env:
          cache-name-rpmbuild: cache-${{ github.sha }}-${{ github.run_id }}-rpmbuild-plugin-packs
        with:
          path: ./*.rpm
          key: ${{ env.cache-name-rpmbuild }}-${{ matrix.distrib }}

  plugin-packs-packaging-deb:
    runs-on: [self-hosted, common]

    strategy:
      matrix:
        include:
          - image: packaging-plugin-packs-bullseye
            distrib: bullseye
            path: plugin-packs/debian

    steps:
      - name: Checkout sources
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: 'Get minor and release version'
        uses: ./.github/actions/get-package-version
        with:
          module_name: ${{ env.module }}
        id: get_version

      - name: Login to Registry
        uses: docker/login-action@v2
        with:
          registry: docker.registry.apps.centreon.com
          username: ${{ secrets.NEXUS_RPMS_REPOSITORY_USERNAME }}
          password: ${{ secrets.NEXUS_RPMS_REPOSITORY_PASSWORD }}

      - name: Package
        uses: ./.github/actions/runner-docker
        with:
          script_name: ${{ matrix.path }}/plugin-packs-packaging
          image_name: ${{ matrix.image }}
          image_version: ${{ env.version }}
          params: ${{ env.version }}.${{ steps.get_version.outputs.minor_version }} ${{ steps.get_version.outputs.release }}

      - name: Use cache DEB files
        uses: actions/cache@v3
        env:
          cache-name-debbuild: cache-${{ github.sha }}-${{ github.run_id }}-debbuild-plugin-packs
        with:
          path: ./*.deb
          key: ${{ env.cache-name-debbuild }}-${{ matrix.distrib }}

#
#  delivery-rpm:
#    needs: [plugin-packs-packaging-rpm]
#    runs-on: [self-hosted, common]
#    strategy:
#      matrix:
#        include:
#          - module_name: plugin-packs
#            distrib: el7
#          - module_name: plugin-packs
#            distrib: el8
#    steps:
#      - name: Checkout sources
#        uses: actions/checkout@v3
#
#      - name: Delivery
#        uses: ./.github/actions/rpm-delivery
#        with:
#          module_name: ${{ matrix.module_name }}
#          distrib: ${{ matrix.distrib }}
#          version: ${{ env.version }}
#          nexus_username: ${{ secrets.NEXUS_RPMS_REPOSITORY_USERNAME }}
#          nexus_password: ${{ secrets.NEXUS_RPMS_REPOSITORY_PASSWORD }}
#
#  delivery-debian:
#    needs: [plugin-packs-packaging-deb]
#    runs-on: [self-hosted, common]
#    strategy:
#      matrix:
#        include:
#          - module_name: plugin-packs
#            distrib: bullseye
#    steps:
#      - name: Checkout sources
#        uses: actions/checkout@v3
#
#      - name: Delivery
#        uses: ./.github/actions/deb-delivery
#        with:
#          module_name: ${{ matrix.module_name }}
#          distrib: ${{ matrix.distrib }}
#          version: ${{ env.version }}
#          nexus_username: ${{ secrets.NEXUS_RPMS_REPOSITORY_USERNAME }}
#          nexus_password: ${{ secrets.NEXUS_RPMS_REPOSITORY_PASSWORD }}
