name: prepare-widgets

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/prepare-widgets.yml'
      - 'widgets/**'
  push:
    paths:
      - '.github/workflows/prepare-widgets.yml'
      - 'widgets/**'
    tags:
      - centreon-widget.**

env:
  version: "22.10"
  module: "widgets"

jobs:
  get-modules:
    runs-on: [self-hosted, common]
    name: Get modules for building
    container: ubuntu
    outputs:
      matrix: ${{ steps.command.outputs.matrix }}
    steps:
      - name: Install git and python3
        run: apt update && apt install -y git python3-git

      - uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Get widget modules
        id: command
        run: |
          git config --global --add safe.directory $(pwd)
          JSON=$(cat << EOF | python3
          from os import path
          from git import Repo
          import json
          import re
          repo = Repo()
          commits = list(repo.iter_commits())
          dir = { "include": [] }
          for i in commits[1].diff(commits[2]):
            if re.match(r'^widgets\/centreon-widget.*', path.dirname(i.a_path)):
              module = re.search(r'centreon-widget.*?(?=\/|$)', path.dirname(i.a_path)).group()
              if module not in [x['module-name'] for x in dir['include']]:
                dir['include'].append({'module-name': module})
          if dir['include'] == []:
            dir = []
          print(json.dumps(dir))
          EOF
          )
          echo "matrix=$(echo "$JSON")" >> $GITHUB_OUTPUT
          echo $JSON
          if [ "$(echo $JSON)" -eq "[]" ]; then
            echo "::notice::There are no modifications to the modules"
          fi

  build-widgets:
    name: Build Widget
    needs: get-modules
    if: ${{ needs.get-modules.outputs.matrix != '[]' }}
    strategy:
      matrix: ${{ fromJson(needs.get-modules.outputs.matrix) }}
    uses: ./.github/workflows/run-widgets.yml
    with:
      module-name: ${{ matrix.module-name }}
    secrets:
      nexus_username: ${{ secrets.NEXUS_RPMS_REPOSITORY_USERNAME }}
      nexus_password: ${{ secrets.NEXUS_RPMS_REPOSITORY_PASSWORD }}
