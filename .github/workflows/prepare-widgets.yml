name: prepare-widgets

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/prepare-widgets.yml'
      - 'widgets/**'
  push:
    paths:
      - '.github/workflows/prepare-widgets.yml'
      - 'widgets/**'
    tags:
      - centreon-widget.**

env:
  version: "22.10"
  module: "widgets"


jobs:
  get-modules:
    runs-on: [self-hosted, common]
    name: Get modules to build
    container: ubuntu
    outputs:
      modules: ${{ steps.command.outputs.dirs }}
    steps:
      - name: Update cointainer and install git and python3
        run: |
          apt update
          apt upgrade -y
          apt install -y git python3-git

      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: List modules
        id: command
        run: |
          git config --global --add safe.directory $(pwd)
          JSON=$(cat << EOF | python3
          from os import path
          from git import Repo
          import json
          repo = Repo()
          commits = list(repo.iter_commits())
          diff = commits[0].diff(commits[1])
          dir = { "module-name": [] }
          for i in diff:
            if '${{ env.module }}' in i.a_path:
              dir['module-name'].append(path.dirname(i.a_path))
          print(json.dumps(sorted(set(dir['module-name']))))
          EOF
          )
          echo "::set-output name=matrix::$(echo "$JSON")"

  build-widgets:
    name: Build Widgets
    needs: get-modules
    strategy:
      matrix: ${{ fromJson(needs.get-modules.outputs.modules) }}
        #module-name: ${{ needs.get-modules.outputs.modules }}
        #module-name: ["centreon-widget-engine-status", "centreon-widget-global-health"]
    uses: ./.github/workflows/run-widgets.yml
    with:
      module-name: ${{ matrix.module-name }}
