name: prepare-widgets

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/prepare-widgets.yml'
      - 'widgets/**'
  push:
    paths:
      - '.github/workflows/prepare-widgets.yml'
      - 'widgets/**'
    tags:
      - centreon-widget.**

env:
  version: "22.10"
  module: "centreon-widget-engine-status"


jobs:
  get-modules:
    runs-on: [self-hosted, common]
    name: Get modules to build
    container: ubuntu
    outputs:
      folders: ${{ steps.command.outputs.dirs }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Update cointainer and install git
        run: apt update -y && apt upgrade -y && apt install -y git

      - name: Get changed directories
        id: changed-files
        uses: tj-actions/changed-files@v33

      - name: List modules
        id: command
        #run: echo -n "[ "; (cd widgets && find . -maxdepth 1 -type d -printf "%f\n" | sed 1d)|while read MODULE; do echo -n ${MODULE}; echo -n ", "; done | sed 's/\(.*\), /\1 /'; echo -n "]"
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "$file"
          done
