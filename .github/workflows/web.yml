name: web

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'
  pull_request:
    paths:
      - "centreon/**"
      - "!centreon/packages/**"
  push:
    branches:
      - develop
      - dev-[2-9][0-9].[0-9][0-9].x
      - master
      - "[2-9][0-9].[0-9][0-9].x"
    paths:
      - "centreon/**"
      - "!centreon/packages/**"
    tags:
      - centreon-*

env:
  base_directory: centreon
  widgets_directory: centreon/www/widgets

jobs:
  changes:
    runs-on: ubuntu-22.04
    outputs:
      has_frontend_changes: ${{ steps.filter.outputs.has_frontend_changes }}
      has_backend_changes: ${{ steps.filter.outputs.has_backend_changes }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            has_frontend_changes:
              - '**/*.[jt]sx?'
              - '**/www/front_src/**'
              - '**/tests/e2e/**'
              - '**/package*'
              - '**/lighthouse/**'
              - '**/tsconfig.json'
              - '**/cypress/**|**/pnpm-*'
            has_backend_changes:
              - '**/*.php'
              - '**/phpstan*.neon'
              - 'centreon/codingstyle.xml'
              - 'centreon/config/**/*.xml'
              - 'centreon/phpunit.xml'
              - 'centreon/ruleset.xml'
              - 'centreon/www/**/*.xml'
              - '**/bin/**'
              - '**/tmpl/**'
              - '**/features/**'
              - '/centreon/src/**'
              - '**/config/**'
              - '**/composer.*'
              - '**/tests/api/**'
              - '**/tests/php/**'
              - '**/tests/clapi_export/**'
              - '**/www/!(front_src)/**'
              - '**/doc/API/**'
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

  get-version:
    uses: ./.github/workflows/get-version.yml
    with:
      version_file: centreon/www/install/insertBaseConf.sql

  veracode-analysis:
    needs: [get-version]
    uses: ./.github/workflows/veracode-analysis.yml
    with:
      module_directory: centreon
      module_name: centreon-web
      major_version: ${{ needs.get-version.outputs.major_version }}
      minor_version: ${{ needs.get-version.outputs.minor_version }}
      stability: ${{ needs.get-version.outputs.stability }}
    secrets:
      veracode_api_id: ${{ secrets.VERACODE_API_ID_WEB }}
      veracode_api_key: ${{ secrets.VERACODE_API_KEY_WEB_2 }}
      veracode_srcclr_token: ${{ secrets.VERACODE_SRCCLR_TOKEN }}
