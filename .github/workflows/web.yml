name: web
run-name:
  ${{ github.event_name == 'schedule' && format('web nightly {0}', github.ref ) ||
  github.event_name == 'pull_request' && github.event.pull_request.title ||
  github.event_name == 'push' && github.event.head_commit.message ||
  github.event_name == 'workflow_dispatch' && github.workflow || 'unknown' }}
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"
  pull_request:
  push:
    branches:
      - develop
      - dev-[2-9][0-9].[0-9][0-9].x
      - master
      - "[2-9][0-9].[0-9][0-9].x"
    paths:
      - "centreon/**"
      - "!centreon/packages/**"
    tags:
      - centreon-*

env:
  base_directory: centreon
  widgets_directory: centreon/www/widgets

jobs:
  get-version:
    uses: ./.github/workflows/get-version.yml
    with:
      version_file: centreon/www/install/insertBaseConf.sql

  newman-test:
    needs: [get-version]
    uses: ./.github/workflows/newman.yml
    with:
      collection_path: centreon/tests/rest_api/collections
      image_name: centreon-web
      os: alma9
      container_name: my_centreon_container
      centreon_url: http://localhost
      centreon_image: ${{ vars.DOCKER_INTERNAL_REGISTRY_URL }}/centreon-web-slim-alma9:develop
      dependencies_lock_file: centreon/pnpm-lock.yaml
      major_version: ${{ needs.get-version.outputs.major_version }}
      stability: ${{ needs.get-version.outputs.stability }}
    secrets:
      registry_username: ${{ secrets.DOCKER_REGISTRY_ID}}
      registry_password: ${{ secrets.DOCKER_REGISTRY_PASSWD }}
      client_id: ${{ secrets.XRAY_CLIENT_ID }}
      client_secret: ${{ secrets.XRAY_CLIENT_SECRET }}
      jira_user: ${{ secrets.XRAY_JIRA_USER_EMAIL }}
      jira_token_test: ${{ secrets.XRAY_JIRA_TOKEN }}
