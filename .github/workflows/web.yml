name: web

on:
  workflow_dispatch:
  pull_request:
    paths:
      - ".github/workflows/web.yml"
      - "centreon/**"
      - "ci/**"
  push:
    branches:
      - develop
    paths:
      - ".github/workflows/web.yml"
      - "centreon/**"
    tags:
      - centreon-22.10.**

env:
  version: "22.10"
  frontend_directory: ./centreon/www/front_src/src


jobs:
  centreon-web-package-rpm:
    runs-on: common

    strategy:
      matrix:
        include:
          - image: packaging-web-centos7
            distrib: el7
          - image: packaging-web-alma8
            distrib: el8

    steps:
      - name: Checkout sources
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: "Get minor and release version"
        uses: ./.github/actions/get-package-version
        with:
          module_name: ${{ env.module }}
        id: get_version

      - name: Package
        uses: ./.github/actions/runner-docker
        with:
          script_name: web-packaging-rpm
          image_name: ${{ matrix.image }}
          image_version: ${{ env.version }}
          params: ${{ env.version }}.${{ steps.get_version.outputs.minor_version }} ${{ steps.get_version.outputs.release }}

      - name: Sign
        uses: ./.github/actions/runner-docker
        with:
          script_name: rpm-signing
          image_name: rpm-signing
          image_version: ubuntu

      - name: Cache RPM files
        uses: actions/cache@v3
        env:
          cache-name-rpmbuild: cache-${{ github.sha }}-${{ github.run_id }}-rpmbuild-web
        with:
          path: ./*.rpm
          key: ${{ env.cache-name-rpmbuild }}-${{ matrix.distrib }}
  
  centreon-web-package-deb:
    runs-on: common
    
    strategy:
      matrix:
        include:
          - image: packaging-web-bullseye
            distrib: bullseye

    steps: 
      - name: Checkout sources
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: 'Get minor and release version'
        uses: ./.github/actions/get-package-version
        with:
          module_name: ${{ env.module }}
        id: get_version

      - name: Package
        uses: ./.github/actions/runner-docker
        with:
          script_name: web-packaging-deb
          image_name: ${{ matrix.image }}
          image_version: ${{ env.version }}
          params: ${{ env.version }}.${{ steps.get_version.outputs.minor_version }} ${{ steps.get_version.outputs.release }}

      - name: Cache DEB files
        uses: actions/cache@v3
        env:
          cache-name-debbuild: cache-${{ github.sha }}-${{ github.run_id }}-debbuild-web
        with:
          path: ./*.deb
          key: ${{ env.cache-name-debbuild }}-${{ matrix.distrib }}

  centreon-web-dockerize:
    runs-on: common
    needs: [centreon-web-package-rpm, centreon-web-package-deb]

    strategy:
      matrix:
        include:
          - project: run-centreon-open-source
            distrib: centos7
            distrib_rpm: el7
            module_name: web

    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

      - name: Login to Registry
        uses: docker/login-action@v2
        with:
          registry: docker.registry.apps.centreon.com
          username: ${{ secrets.NEXUS_RPMS_REPOSITORY_USERNAME }}
          password: ${{ secrets.NEXUS_RPMS_REPOSITORY_PASSWORD }}

      - name: build docker run
        uses: ./.github/actions/docker-builder-run
        with:
          distrib: ${{ matrix.distrib }}
          project: ${{ matrix.project }}
          distrib_rpm: ${{ matrix.distrib_rpm }}
          module_name: ${{ matrix.module_name }}

  centreon-web-test-e2e:
    runs-on: common
    needs: [centreon-web-dockerize]

    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

      - name: Cypress e2e testing
        uses: ./.github/actions/cypress-e2e-testing
        with:
          image: docker.registry.apps.centreon.com/run-centreon-open-source-centos7
          image_version: ${{ github.head_ref || github.ref_name }}
          image_cypress_version: ${{ env.version }}
          module: centreon

      - name: Archive videos
        uses: actions/upload-artifact@v3
        if: ${{ failure() }}
        with:
          name: cypress-videos
          path: centreon/tests/e2e/cypress/results/video

      - name: Publish report
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          check_name: "centreon-web-frontend-e2e-tests-report"
          comment_mode: failures
          junit_files: centreon/tests/e2e/cypress-result.xml

  centreon-web-deliver-rpm:
    runs-on: common
    needs: [centreon-web-test-e2e]

    strategy:
      matrix:
        include:
          - module_name: web
            distrib: el7

          - module_name: web
            distrib: el8

    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

      - name: Delivery
        uses: ./.github/actions/rpm-delivery
        with:
          module_name: ${{ matrix.module_name }}
          distrib: ${{ matrix.distrib }}
          version: ${{ env.version }}
          nexus_username: ${{ secrets.NEXUS_RPMS_REPOSITORY_USERNAME }}
          nexus_password: ${{ secrets.NEXUS_RPMS_REPOSITORY_PASSWORD }}

  centreon-web-deliver-deb:
    needs: [centreon-web-test-e2e]
    runs-on: common
    strategy:
      matrix:
        include:
          - module_name: web
            distrib: bullseye
    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

      - name: Delivery
        uses: ./.github/actions/deb-delivery
        with:
          module_name: ${{ matrix.module_name }}
          distrib: ${{ matrix.distrib }}
          version: ${{ env.version }}
          nexus_username: ${{ secrets.NEXUS_RPMS_REPOSITORY_USERNAME }}
          nexus_password: ${{ secrets.NEXUS_RPMS_REPOSITORY_PASSWORD }}

  centreon-web-test-performances:
    runs-on: common
    needs: [centreon-web-dockerize]

    steps:
      - uses: actions/checkout@v3

      - name: Run lighthouse
        uses: ./.github/actions/lighthouse-performance-testing
        with:
          path: "centreon/lighthouse"
          image: docker.registry.apps.centreon.com/run-centreon-open-source-centos7
          image_version: ${{ github.head_ref || github.ref_name }}
          image_lighthouse_version: ${{ env.version }}
          module: centreon

      - name: Publish report
        uses: actions/upload-artifact@v3
        with:
          name: lighthouse-report
          path: centreon/lighthouse/report/lighthouseci-index.html
