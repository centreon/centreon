name: check-qa-validation

concurrency:
  group: ${{ github.workflow }}-${{ github.event.action }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

on:
  pull_request:
    branches:
      - develop
      - dev-[2-9][0-9].[0-9][0-9].x
      - master
      - "[2-9][0-9].[0-9][0-9].x"
      - hotfix-*
      - release-*
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
      - labeled
      - unlabeled

jobs:
  fail-when-no-qa-label:
    if: ${{ contains(github.event.pull_request.labels.*.name, 'skip-qa') || contains(github.event.pull_request.labels.*.name, 'qa-approved') }}
    runs-on: ubuntu-24.04
    steps:
      - name: Fail if PR has not been marked as ready by QA
        run: |
          echo "::error::This PR has not been marked as ready for QA (no 'skip-qa' or 'qa-approved' labels)"
          exit 1

  check-qa-validation:
    # if: ${{ ! github.event.pull_request.draft }}
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout sources
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Get PR labels
        id: get-labels
        uses: ./.github/actions/get-pr-labels

      - uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}
          LABELS: ${{ steps.get-labels.outputs.labels }}
        with:
          script: |
            console.log(`Labels: ${process.env.LABELS}`);
