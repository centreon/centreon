name: centreon-plugins

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/centreon-plugins.yml'
      - 'centreon-plugins/**'
  push:
    branches:
      - develop
    paths:
      - '.github/workflows/centreon-plugins.yml'
      - 'centreon-plugins/**'
    tags:
      - centreon-plugins-22.10.**

env:
  version: "22.10"

jobs:

  centreon-plugins-fatpack:
    runs-on: ubuntu-latest

    name: Make fatpack
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Copy script fatpack
        uses: canastro/copy-file-action@master
        with:
          source: "ci/scripts/centreon-plugins/plugins-source.container.pl"
          target: "/usr/local/bin/plugins-source.container.pl"

      - name: Copy package configuration
        uses: canastro/copy-file-action@master
        with:
          source: "ci/scripts/centreon-plugins/packaging"
          target: "/usr/local/src/packaging-centreon-plugins"

      - run: |
          /usr/local/bin/plugins-source.container.pl

      - name: Cache fatpacked plugins
        uses: actions/cache@v3
        env:
          cache-name-fatpack: cache-${{ github.sha }}-${{ github.run_id }}-fatpack
        with:
          path: centreon-plugins-build/
          key: ${{ env.cache-name-fatpack }}-${{ matrix.distrib }}
