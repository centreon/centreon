name: phpcs

on:   
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/centreon.yml'
      - 'centreon/**'
  push:
    branches:
      - develop
    paths:
      - '.github/workflows/centreon.yml'
      - 'centreon/**'
    tags:
      - centreon-22.10.**

env:
  version: "22.10"
  
jobs:

  be-phpcs:

    runs-on: ubuntu-latest

    steps:

    - name: Checkout
      uses: actions/checkout@v2

    - name: Init
      uses: ./.github/actions/init-backend-jobs

    - name: Run changed-files with defaults on the dir1
      id: changed-files-for-centreon
      uses: tj-actions/changed-files@v29.0.3
      with:
        path: centreon

    - name: Run PHPCS
      run: |
           ./vendor/bin/phpcs --extensions=php --standard=./ruleset.xml --report=checkstyle --report-file=./checkstyle-be.xml ${{ steps.changed-files-for-centreon.outputs.added_files }} ${{ steps.changed-files-for-centreon.outputs.modified }}
      working-directory: centreon
      continue-on-error: true

    - name: Checkout Private GitHub Action Repo
      uses: actions/checkout@v2
      with:
        repository: kduret/custom-github-action
        path: centreon/my-action
        ref: master

    - name: Annotate PR from PHPCS result
      working-directory: centreon
      run: |
        ./my-action/cs2pr.php --prefix=PHPCS checkstyle-be.xml
