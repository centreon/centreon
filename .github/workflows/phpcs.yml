name: phpcs

on:   
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/centreon.yml'
      - 'centreon/**'
  push:
    branches:
      - develop
    paths:
      - '.github/workflows/centreon.yml'
      - 'centreon/**'
    tags:
      - centreon-22.10.**

env:
  version: "22.10"
  
jobs:

  be-phpcs:

    runs-on: ubuntu-latest

    steps:

    - name: Checkout
      uses: actions/checkout@v2

    - name: Init
      uses: ./.github/actions/init-backend-jobs

    - name: Get changed files
      id: files
      uses: jitterbit/get-changed-files@v1

    - name: Run PHPCS
      run: |
          cd centreon && ./vendor/bin/phpcs --extensions=php --standard=./ruleset.xml --report=checkstyle --report-file=./checkstyle-be.xml ${{ steps.files.outputs.added }} ${{ steps.files.outputs.modified }}
      continue-on-error: true

    - name: Checkout Private GitHub Action Repo
      uses: actions/checkout@v2
      with:
        repository: kduret/custom-github-action
        path: centreon/my-action
        ref: master

    - name: Annotate PR from PHPCS result
      run: |
        cd centreon && ./my-action/cs2pr.php --prefix=PHPCS checkstyle-be.xml
