name: phpcs

on:   
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/centreon.yml'
      - 'centreon/**'
  push:
    branches:
      - develop
    paths:
      - '.github/workflows/centreon.yml'
      - 'centreon/**'
    tags:
      - centreon-22.10.**

env:
  version: "22.10"
  
jobs:
    phpstan-analysis:
      name: phpstan static code analysis and code sniffer
      runs-on: ubuntu-latest
      steps:
          - uses: actions/checkout@v3
          
          - name: Get changed files
            id: files
            uses: jitterbit/get-changed-files@v1
            
          - name: Setup PHP
            uses: shivammathur/setup-php@v2
            with:
                php-version: 8.0
                coverage: none # disable xdebug, pcov
                tools: cs2pr
          - run: |
                cd centreon
                composer install 
                cd ..
                ./centreon/vendor/bin/phpcs --extensions=php --standard=./centreon/ruleset.xml --report=checkstyle --report-file=./phpcs-report.xml ${{ steps.files.outputs.added }} ${{ steps.files.outputs.modified }}
          - continue-on-error: true

          - name: Show PHPCS results in PR
            run: cs2pr ./phpcs-report.xml
