name: check-status

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

on:
  pull_request:
    branches:
      - develop
      - dev-[2-9][0-9].[0-9][0-9].x
      - master
      - "[2-9][0-9].[0-9][0-9].x"
      - hotfix-*
      - release-*

jobs:
  check-status:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3

      - run: |
          sleep 10s

          ITERATIONS=1
          while [[ $ITERATIONS -le 30 ]]; do
              IFS=$(echo -en "\n\b")
              CHECKS=$(gh pr checks ${{ github.event.number }}) || true
              echo $CHECKS
              echo $CHECKS | grep -E -i '\s+pending\s+' | wc -l

              if [ $(echo $CHECKS | grep -E -i '\s+fail\s+' | wc -l) -gt 0 ]; then
                  echo "some jobs are failed"
                  exit 1
              fi

              # only remaining pending job should be check-status itself
              if [ $(echo $CHECKS | grep -E -i '\s+pending\s+' | wc -l) -eq 1 ]; then
                  echo "all jobs are passed"
                  exit 0
              fi

              if [ $ITERATIONS -lt 30 ]; then
                  echo "some jobs are still in progress, next try in 60 seconds... (tries: $ITERATIONS/30)"
                  sleep 60s
              fi

              ITERATIONS=$((ITERATIONS+1))
          done

          echo "Timeout : some jobs are still in progress"
          exit 1
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
