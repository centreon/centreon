name: check-status

on:
  pull_request:
    branches:
      - develop
      - dev-[2-9][0-9].[0-9][0-9].x
      - master
      - "[2-9][0-9].[0-9][0-9].x"
      - hotfix-*
      - release-*

jobs:
  check-status:
    runs-on: ubuntu-22.04
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - run: |
          sleep 10s

          ITERATIONS=1
          while [[ $ITERATIONS -le 10 ]]; do

              CHECKS="$(gh pr checks | grep -E -i '\s+(fail|pending)\s+'))"
              if [ $(echo $CHECKS | grep -E -i '\s+fail\s+' | wc -l) -gt 0 ]; then
                  echo "some jobs are failed"
                  exit 1
              fi

              # only remaining pending job should be check-status itself
              if [ $(echo $CHECKS | grep -E -i '\s+pending\s+' | wc -l) -eq 1 ]; then
                  echo "all jobs are passed"
                  exit 0
              fi

              if [ $ITERATIONS -lt 10 ]; then
                  echo "some jobs are still in progress, next try in 60 seconds... (tries: $ITERATIONS/10)"
                  sleep 60s
              fi

              ITERATIONS=$((ITERATIONS+1))
          done

          exit 1
        shell: bash