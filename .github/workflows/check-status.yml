name: check-status

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

on:
  pull_request:
    branches:
      - develop
      - dev-[2-9][0-9].[0-9][0-9].x
      - master
      - "[2-9][0-9].[0-9][0-9].x"
      - hotfix-*
      - release-*

jobs:
  check-status:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3

      - run: |
          set -x
          sleep 10s

          ITERATIONS=1
          while [[ $ITERATIONS -le 2 ]]; do
              #CHECKS=$(gh api -H "Accept: application/vnd.github+json" /repos/centreon/centreon/commits/$(git rev-parse HEAD)/check-suites | jq '. | .check_suites[] | select(.app.slug == "github-actions")' | jq .conclusion)
              #echo before
              #echo $CHECKS
              #echo after
              #echo $(gh api -H "Accept: application/vnd.github+json" /repos/centreon/centreon/commits/$(git rev-parse HEAD)/check-suites)
              #CHECKS="$(gh pr checks ${{ github.event.number }})" || true
              #echo $CHECKS

              #echo $CHECKS | grep -E -i -c '\s+success\s+'

              gh api -H "Accept: application/vnd.github+json" /repos/centreon/centreon/commits/$(git rev-parse HEAD)/check-runs | jq -r '.check_runs[] | .conclusion // "pending"'
              CHECKS=$(gh api -H "Accept: application/vnd.github+json" /repos/centreon/centreon/commits/$(git rev-parse HEAD)/check-runs | jq -r '.check_runs[] | .conclusion // "pending"')
              echo $CHECKS

              if [ $(echo $CHECKS | grep -E -i -c '\s+fail\s+') -gt 0 ]; then
                  echo "some jobs are failed"
                  exit 1
              fi

              # only remaining pending job should be check-status itself
              if [ $(echo $CHECKS | grep -E -i -c '\s+pending\s+') -eq 1 ]; then
                  echo "all jobs are passed"
                  exit 0
              fi

              if [ $ITERATIONS -lt 2 ]; then
                  echo "some jobs are still in progress, next try in 60 seconds... (tries: $ITERATIONS/30)"
                  sleep 60s
              fi

              ITERATIONS=$((ITERATIONS+1))
          done

          echo "Timeout : some jobs are still in progress"
          exit 1
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
