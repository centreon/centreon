name: check-status

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

on:
  pull_request:
    branches:
      - develop
      - dev-[2-9][0-9].[0-9][0-9].x
      - master
      - "[2-9][0-9].[0-9][0-9].x"
      - hotfix-*
      - release-*

jobs:
  check-status:
    runs-on: ubuntu-24.04
    steps:
      - name: Check workflow statuses and display token usage
        run: |
          echo "current token usage :"
          curl -s -H "Accept: application/vnd.github+json" -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/rate_limit | jq .rate
          echo ""

      - uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}
        with:
          script: |
            for (let i = 0; i < 60; i++) {
              let myOutput = '';
              let myError = '';

              const success = [];
              const failure = [];
              const in_progress = [];

              const options = {};
              options.listeners = {
                stdout: (data) => {
                  myOutput += data.toString();
                },
                stderr: (data) => {
                  myError += data.toString();
                }
              };

              const pr_checks = await exec.exec(
                "gh pr checks --repo centreon/centreon ${{ env.PR_NUMBER }} --json name,state",
                [],
                options
              );
              console.log(myOutput);
              console.log(myError)
              JSON.parse(myOutput).forEach(({ name, state }) => {
                if (state.toLowerCase() === 'failure') {
                  failure.push(name);
                } else if (state.toLowerCase() === 'in_progress') {
                  in_progress.push(name);
                }
                console.log(`${name} => ${state}`);
              });

              if (in_progress.length === 0) {
                core.setFailed("Cannot get pull request check status");
                return;
              }

              if (failure.length > 0) {
                core.setFailed(`${failure.length} job(s) failed: ${failure.join(', ')}`);
                return;
              }

              if (in_progress.length === 1) {
                core.info("All jobs are ok");
                return;
              }

              await exec.exec("sleep 1s");
            }

            core.setFailed("Timeout: some jobs are still in progress");

      - name: Check workflow statuses and display token usage
        run: |
          echo "current token usage :"
          curl -s -H "Accept: application/vnd.github+json" -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/rate_limit | jq .rate
          echo ""

      # - name: Check workflow statuses and display token usage
      #   run: |
      #     echo "current token usage :"
      #     curl -s -H "Accept: application/vnd.github+json" -H "Authorization: token ${{ secrets.PERSONAL_ACCESS_TOKEN }}" https://api.github.com/rate_limit | jq .rate
      #     echo ""

      #     # sleep 30s

      #     ITERATIONS=1
      #     while [[ $ITERATIONS -le 60 ]]; do
      #       PR_CHECKS=$(gh pr checks ${{ env.PR_NUMBER }} --json name,state)
      #         # display_token_usage
      #         # echo "api"
      #         # CHECK_SUITES=$(gh api -H "Accept: application/vnd.github+json" /repos/centreon/centreon/commits/${{ github.event.pull_request.head.sha }}/check-suites | jq '. | .check_suites[] | select(.app.slug == "github-actions")' | jq -r '.conclusion // "pending"') || true
      #         # display_token_usage
      #         # echo "gh cli"
      #         # gh pr checks ${{ env.PR_NUMBER }} --json name,state
      #         # display_token_usage

      #         if [ $(echo "$CHECK_SUITES" | grep -o -i 'pending' | wc -l) -eq 0 ]; then
      #             echo "Cannot get pull request check status"
      #             exit 1
      #         fi

      #         if [ $(echo "$CHECK_SUITES" | wc -w) -eq 1 ]; then
      #             echo "this job is the only triggered one"
      #             exit 0
      #         fi

      #         if [ $(echo "$CHECK_SUITES" | grep -o -i 'failure' | wc -l) -gt 0 ]; then
      #             echo "some jobs have failed"
      #             exit 1
      #         fi

      #         # only remaining pending job should be check-status itself
      #         if [ $(echo "$CHECK_SUITES" | grep -o -i 'pending' | wc -l) -eq 1 ]; then
      #             echo "all jobs have passed"
      #             exit 0
      #         fi

      #         if [ $ITERATIONS -lt 60 ]; then
      #             echo "some jobs are still in progress, next try in 60 seconds... (tries: $ITERATIONS/60)"
      #             sleep 30s
      #             display_token_usage
      #             sleep 30s
      #             display_token_usage
      #         fi

      #         ITERATIONS=$((ITERATIONS+1))
      #     done

      #     echo "Timeout : some jobs are still in progress"
      #     exit 1
      #   shell: bash
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      #     PR_NUMBER: ${{ github.event.number }}
