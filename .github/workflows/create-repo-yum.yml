name: create-repo-yum

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

on:
  workflow_dispatch:
  pull_request:
    paths:
      - ".github/workflows/create-repo-yum.yml"

jobs:
  get-version:
    uses: ./.github/workflows/get-version.yml
    with:
      version_file: centreon/www/install/insertBaseConf.sql

  create-repo-file-and-deliver:
    needs: [get-version]
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        distrib: [el9]
        #distrib: [el8, el9]

    steps:
      - name: Checkout sources
        uses: actions/checkout@v3

      - name: Install jfrog cli
        uses: jfrog/setup-jfrog-cli@v3
        env:
          JF_URL: https://centreon.jfrog.io
          JF_ACCESS_TOKEN: ${{ secrets.ARTIFACTORY_ACCESS_TOKEN }}

      - name: Create .repo file
        run: |
          sed \
            -e "s#@MAJOR_VERSION@#${{ needs.get-version.outputs.major_version }}#g" \
            -e "s#@DISTRIB@#${{ matrix.distrib }}#g" \
            ./.github/scripts/repo/centreon.repo.template > ./centreon.repo
        shell: bash

      - name: Create repository structure
        run: |
          mkdir -p stability/x86_64
          mkdir -p stability/noarch
          jf rt upload --include-dirs=true "stability" "rpm/standard/${{ needs.get-version.outputs.major_version }}/${{ matrix.distrib }}/stable/"
        shell: bash

      - name: Upload repo file in jfrog
        run: |
          jf rt upload "centreon.repo" "rpm/standard/${{ needs.get-version.outputs.major_version }}/${{ matrix.distrib }}/"
        shell: bash
