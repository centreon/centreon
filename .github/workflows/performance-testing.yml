name: Performance Testing

on:
  pull_request:
  workflow_dispatch:
   inputs:
      input1:
        description: "Premier input"
        required: true
        type: string
      input2:
        description: "Deuxi√®me input"
        required: true
        type: string

  workflow_call:  # Permet d'ex√©cuter depuis un autre workflow
    inputs:
      image_name:
        required: true
        type: string
      os:
        required: true
        type: string
      container_name:
        required: true
        type: string
      centreon_url:
        required: true
        type: string
      centreon_image:
        required: true
        type: string
      database_image:
        required: true
        type: string
      major_version:
        required: true
        type: string
      stability:
        required: true
        type: string

jobs:
  performance-test:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash
        working-directory: centreon/tests/performanceTesting

    env:
      IMAGE_TAG: ${{ github.head_ref || github.ref_name }}
      SLIM_IMAGE_NAME: ${{ inputs.image_name }}-slim-${{ inputs.os }}
      CONTAINER_NAME: ${{ inputs.container_name }}
      CENTREON_URL: ${{ inputs.centreon_url }}
      WEB_IMAGE: ${{ inputs.centreon_image }}
      DATABASE_IMAGE: ${{ inputs.database_image }}
      CSV_FILE_PATH: users.csv

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4  # R√©cup√®re le code source

      - name: Setup Node.js
        uses: actions/setup-node@v4.2.0
        with:
          node-version: 20

      - name: Install Dependencies
        run: npm ci  # Installation des d√©pendances en mode clean

      - name: Login to Docker Registry
        uses: docker/login-action@v3.3.0
        with:
          registry: ${{ vars.DOCKER_INTERNAL_REGISTRY_URL }}
          username: ${{ secrets.HARBOR_CENTREON_PULL_USERNAME }}
          password: ${{ secrets.HARBOR_CENTREON_PULL_TOKEN }}

      - name: Start Centreon Web and Database Containers
        env:
          WEB_IMAGE: 'docker.centreon.com/centreon/centreon-web-slim-alma9:MON-159979'
          MYSQL_IMAGE: 'bitnami/mariadb:10.11'
        run: |
            # D√©marrer les services Docker avec docker-compose
            docker compose --profile web -f ../../../.github/docker/docker-compose.yml up -d --wait

            # V√©rifier si un script de configuration est n√©cessaire et l'ex√©cuter
            if [[ -f "../../../.github/docker/setup.sh" ]]; then
            echo "Running setup.sh ..."
            bash -ex "../../../.github/docker/setup.sh"
            fi

            # Ex√©cuter un script de configuration suppl√©mentaire pour le service web si n√©cessaire
            if [[ -f "../../../.github/docker/setup-web.sh" ]]; then
            echo "Running setup-web.sh ..."
            docker compose -f ../../../.github/docker/docker-compose.yml cp ../../../.github/docker/setup-web.sh web:/tmp/setup-web.sh
            docker compose -f ../../../.github/docker/docker-compose.yml exec web bash -ex "/tmp/setup-web.sh"
            fi
        shell: bash

      - name: Adding hosts
        run: node addingHosts.mjs  # Ex√©cute ton script

      - name: Adding users
        run: node AddingUsers.mjs  # Ex√©cute ton script

      - name: Debug GitHub Workspace
        run: |
            echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
            ls -la $GITHUB_WORKSPACE

      - name: Install JMeter
        run: |
          java -version
          echo "Finding latest JMeter version..."
          JMETER_VERSION=$(curl -s https://downloads.apache.org/jmeter/binaries/ | grep -oP 'apache-jmeter-\d+\.\d+\.\d+\.zip' | sort -V | tail -n 1 | sed 's/apache-jmeter-\(.*\).zip/\1/')

          echo "Latest JMeter version: $JMETER_VERSION"

          echo "Downloading JMeter..."
          wget -q "https://downloads.apache.org/jmeter/binaries/apache-jmeter-${JMETER_VERSION}.zip" -O jmeter.zip || { echo "Download failed!"; exit 1; }

          echo "Unzipping JMeter..."
          unzip -q jmeter.zip || { echo "Unzip failed!"; exit 1; }

          rm jmeter.zip
          echo "JMeter installed successfully!"


      - name: Install JMeter Plugins
        run: |
          JMETER_DIR=$(ls -d $GITHUB_WORKSPACE/centreon/tests/performanceTesting/apache-jmeter-*/)
          cd $JMETER_DIR || { echo "JMeter directory not found!"; exit 1; }

          wget -q --no-check-certificate https://jmeter-plugins.org/files/packages/jpgc-dummy-0.4.zip
          unzip -o jpgc-dummy-0.4.zip
          rm jpgc-dummy-0.4.zip  # Nettoyage apr√®s installation
          echo "Plugins installed successfully!"

      - name: Run JMX Scripts
        run: |
          JMETER_DIR=$(ls -d $GITHUB_WORKSPACE/centreon/tests/performanceTesting/apache-jmeter-*/bin)
          cd $JMETER_DIR || { echo "JMeter bin directory not found!"; exit 1; }

          mkdir -p $GITHUB_WORKSPACE/centreon/tests/performanceTesting/jmeterFolder/jmeter_results  # Cr√©er le dossier de r√©sultats
          mkdir -p $GITHUB_WORKSPACE/centreon/tests/performanceTesting/jmeterFolder/jmeter_html_report  # Cr√©er le dossier pour le rapport HTML

          for i in $GITHUB_WORKSPACE/centreon/tests/performanceTesting/jmeterFolder/*.jmx; do
              echo "Running test: $i"
              ./jmeter -n -t "$i" -l $GITHUB_WORKSPACE/jmeter_results/results_$(basename "$i" .jmx).jtl -e -o $GITHUB_WORKSPACE/centreon/tests/performanceTesting/jmeterFolder/jmeter_html_report/$(basename "$i" .jmx)
          done
          echo "Tests completed!"

      - name: Upload JMeter Results
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-results
          path: jmeter_results

      - name: Upload JMeter HTML Reports
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-html-reports
          path: centreon/tests/performanceTesting/jmeterFolder/jmeter_html_report

      - name: Display HTML Report in GitHub Summary
        run: |
          echo "Looking for JTL files..."
          ls -la $GITHUB_WORKSPACE/jmeter_results

          # Find a JTL file
          JTL_FILE=$(ls $GITHUB_WORKSPACE/jmeter_results/*.jtl | head -n 1)
          echo "Found JTL file: $JTL_FILE"

          # Check if the file exists before using it
          if [ ! -f "$JTL_FILE" ]; then
              echo "Error: No JTL file found!"
              exit 1
          fi

          # Comptabiliser succ√®s et √©checs
          SUCCESS_COUNT=$(grep -c ",true," "$JTL_FILE")
          FAILURE_COUNT=$(grep -c ",false," "$JTL_FILE")
          TOTAL=$((SUCCESS_COUNT + FAILURE_COUNT))

          echo "Success: $SUCCESS_COUNT, Failure: $FAILURE_COUNT"

          # Calcul des angles pour le camembert
          if [ "$TOTAL" -gt 0 ]; then
              SUCCESS_ANGLE=$((360 * SUCCESS_COUNT / TOTAL))
              FAILURE_ANGLE=$((360 - SUCCESS_ANGLE))
          else
              SUCCESS_ANGLE=0
              FAILURE_ANGLE=0
          fi

          # G√©n√©rer le camembert en SVG
          SVG_FILE="$GITHUB_WORKSPACE/jmeter_results/pie_chart.svg"
          cat <<EOF > "$SVG_FILE"
          <svg width="200" height="200" viewBox="0 0 32 32">
              <circle r="16" cx="16" cy="16" fill="#e74c3c"></circle>
              <path d="M16 16 L16 0 A16 16 0 $([ "$SUCCESS_ANGLE" -gt 180 ] && echo 1 || echo 0) 1 $(awk -v angle="$SUCCESS_ANGLE" 'BEGIN { rad=angle*3.141592/180; printf "%.2f %.2f", 16+16*cos(rad), 16-16*sin(rad) }')" fill="#2ecc71"></path>
          </svg>
          EOF

          # Ajouter le camembert au GitHub Summary
          echo "### JMeter Test Results" >> $GITHUB_STEP_SUMMARY
          echo "#### Success vs Failure" >> $GITHUB_STEP_SUMMARY
          echo '<img src="data:image/svg+xml;base64,'$(base64 -w 0 "$SVG_FILE")'" width="200"/>' >> $GITHUB_STEP_SUMMARY

          # Ajouter le tableau HTML des r√©sultats
          echo "<h2>JMeter Test Results</h2>" >> $GITHUB_STEP_SUMMARY
          echo "<table style='width:100%; border-collapse: collapse; border: 1px solid #ddd; text-align: left;'>" >> $GITHUB_STEP_SUMMARY
          echo "<thead><tr><th>Timestamp</th><th>Elapsed (ms)</th><th>Label</th><th>Response Code</th><th>Response Message</th><th>Thread Name</th><th>Success</th><th>Bytes</th><th>Latency (ms)</th></tr></thead>" >> $GITHUB_STEP_SUMMARY
          echo "<tbody>" >> $GITHUB_STEP_SUMMARY

          # Lire le fichier JTL et g√©n√©rer le tableau HTML
          while IFS=',' read -r timestamp elapsed label response_code response_message thread_name data_type success failure_message bytes sent_bytes grp_threads all_threads url latency idle_time connect
          do
              # Skip the header row
              if [ "$timestamp" == "timeStamp" ]; then
                  continue
              fi

              # Check if success is "true" for success (üü¢), else failure (üî¥)
              if [ "$success" == "true" ]; then
                  success_icon="üü¢"
              else
                  success_icon="üî¥"
              fi

              # If Latency is "null", "0", or empty, set it to "N/A"
              if [[ "$latency" == "null" || "$latency" == "0" || -z "$latency" ]]; then
                  latency="N/A"
              fi

              # Generate the HTML table row
              echo "<tr><td>$timestamp</td><td>$elapsed</td><td>$label</td><td>‚úÖ $response_code</td><td>$response_message</td><td>$thread_name</td><td>$success_icon</td><td>$bytes</td><td>$latency</td></tr>" >> $GITHUB_STEP_SUMMARY
          done < "$JTL_FILE"

          echo "</tbody></table>" >> $GITHUB_STEP_SUMMARY
