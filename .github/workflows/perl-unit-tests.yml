name: perl-unit-tests
# this simple workflow is used to run the unit tests on the perl code in this repo.
# We can't add this before the packaging, as the packaging is generic for all Centreon package.

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/perl-unit-tests.yml'
      - 'centreon/lib/perl/**'
      - 'centreon/packaging/centreon-perl*.yaml'
  push:
    branches:
      - develop
      - master
    paths:
      - '.github/workflows/perl-unit-tests.yml'
      - 'centreon/lib/perl/**'
      - 'centreon/packaging/centreon-perl*.yaml'


jobs:
  unit-tests:
    strategy:
      fail-fast: false
      matrix:
        image: [unit-tests-alma8, unit-tests-alma9, unit-tests-bullseye, unit-tests-bullseye-arm64, unit-tests-bookworm, unit-tests-jammy]
        include:
          - runner_name: ubuntu-22.04
          - package_extension: rpm
            image: unit-tests-alma8
            distrib: el8
          - package_extension: rpm
            image: unit-tests-alma9
            distrib: el9
          - package_extension: deb
            image: unit-tests-bullseye
            distrib: bullseye
          - package_extension: deb
            image: unit-tests-bullseye-arm64
            distrib: bullseye-arm64
            runner_name: ["self-hosted", "collect-arm64"]
          - package_extension: deb
            image: unit-tests-bookworm
            distrib: bookworm
          - package_extension: deb
            image: unit-tests-jammy
            distrib: jammy
    runs-on: ${{ matrix.runner_name }}
    container:
      image: ${{ vars.DOCKER_INTERNAL_REGISTRY_URL }}/${{ matrix.image }}
      credentials:
        username: ${{ secrets.HARBOR_CENTREON_PULL_USERNAME }}
        password: ${{ secrets.HARBOR_CENTREON_PULL_TOKEN }}
    steps:
      - name: Checkout sources
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Run unit tests
        run: yath -L test ./centreon/lib/perl/

      - name: Upload logs as artifacts if tests failed
        if: failure()
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: plugin-installation-${{ matrix.distrib }}
          path: ./lastlog.jsonl
          retention-days: 1
