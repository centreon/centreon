on:
  workflow_call:
    outputs:
      test_plan_key:
        description: "the test plan key"
        value: ${{ jobs.get-test-plan-key.outputs.test_plan_key }}
    secrets:
      client_id:
        required: true
      client_secret:
        required: true
      xray_token:
        required: true

jobs:
  get-version:
    uses: ./.github/workflows/get-version.yml
    with:
      version_file: centreon/www/install/insertBaseConf.sql

  # NIGHTLY <OSS|MODULES|COLLECT> <MAJOR_VERSION> (e.g., NIGHTLY OSS 23.10)
  get-test-plan-key:
    runs-on: ubuntu-22.04
    needs: [get-version]
    outputs:
      test_plan_key: ${{ steps.get_test_plan_key.outputs.test_plan_key }}

    steps:
      - name: Get the TestPlanKey
        id: get_test_plan_key
        run: |
          # Use a GraphQL query to get all test plans matching the JQL
          graphql_query='{
            "query":"query GetTestPlans($jql: String, $limit: Int!) { getTestPlans(jql: $jql, limit: $limit) { total results { issueId jira(fields: [\"summary\", \"key\"]) } } }",
            "variables":{"jql": "project = MON","limit": 100}}'

          # Execute the GraphQL query and parse the results
          response=$(curl -H "Content-Type: application/json" -X POST -H "Authorization: Bearer ${{ secrets.xray_token }}" --data "$graphql_query" "https://xray.cloud.getxray.app/api/v2/graphql")

          test_plans=$(echo "$response" | jq -c '.data.getTestPlans.results')

          test_plan_key=$(node - <<EOF
          const data = JSON.parse('$test_plans');
          let test_plan_key = '';
          data.forEach(item => {
              const key = item.jira.key;
              const summary = item.jira.summary;
              if (summary === "NIGHTLY OSS ${{ needs.get-version.outputs.major_version }}") {
                test_plan_key = key;
              }
          });
          console.log(test_plan_key);
          EOF)

          echo "The test plan key for now is: $test_plan_key"

          # If no matching test plan was found, create one
          if [ -z "$test_plan_key" ]; then
            echo "TestPlan doesn't exist yet"

            # Create the test plan using a GraphQL mutation
            create_test_plan_mutation='{
              "query": "mutation CreateTestPlan($testIssueIds: [String], $jira: JSON!) { createTestPlan(testIssueIds: $testIssueIds, jira: $jira) { testPlan { issueId jira(fields: [\"key\"]) } warnings } }",
              "variables": {
                "testIssueIds": [],
                "jira": {
                  "fields": {
                    "summary": "NIGHTLY OSS ${{ needs.get-version.outputs.major_version }}",
                    "project": { "key": "MON" }
                  }
                }
              }
            }'
            create_result=$(curl -H "Content-Type: application/json" -X POST -H "Authorization: Bearer ${{ secrets.xray_token }}" -d "$create_test_plan_mutation" "https://xray.cloud.getxray.app/api/v2/graphql")
            
            echo "API response: $create_result "

            # Extract the key of the created test plan
            test_plan_key=$(echo "$create_result" | jq -r '.data.createTestPlan.testPlan.jira.key')
            echo "New TP created with key: $test_plan_key"
          fi

          # Set the testPlanKey as an output
          echo "test_plan_key=$test_plan_key" >> $GITHUB_OUTPUT
        shell: bash
