name: nightly-cod-platform-destroy

on:
  schedule:
    - cron: "15 19 * * 1-5"

jobs:
  nightly-cod-platform-destroy:
    runs-on: "ubuntu-latest"
    steps:
      - name: Check the status of the last nightly
        id: check-last-nightly-status
        run: |
          set -x

          echo "[INFO]: Filtering the results of the last nightly build"
          lastNightlyRunDetails=$(gh run ls \
            --json number,status,conclusion \
            --event schedule \
            --workflow web.yml \
            --branch develop \
            --limit 1)

          echo "Last nightly run details:"
          echo "$lastNightlyRunDetails"

          echo "lastNightlyResult=$(echo "$lastNightlyRunDetails" | jq .r '.[0].conclusion') >> $GITHUB_OUTPUT
        shell: bash

      - name: Destroy any previous nightly COD platform
        if: ${{ steps.check-last-nightly-status.outputs.lastNightlyResult == 'success' }}
        run: |
            set -x

            # Destroy the previous existing instance everytime
            echo "[INFO]: Destroying the nightly instance of the day."
            curl --fail \
              -s \
              -o /dev/null \
              -X POST \
              -H "Authorization: Bearer ${{ secrets.CENTREON_TECHNIQUE_PAT }}" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/centreon/centreon-on-demand/actions/workflows/destroy.yml/dispatches \
              -d '{"ref": "main", "inputs":{"confirm":"true"} }' \
              -w %http_code
        shell: bash
