# Create Jira ticket on Veracode QG failure
on:
  workflow_call:
    secrets:
      jira_base_url:
        required: true
      jira_user_email:
        required: true
      jira_api_token:
        required: true

env:
  JIRA_PROJECT_KEY: "MON"
  JIRA_ISSUE_TYPE: "Technical"

jobs:
  create_ticket:
    name: Create Jira ticket on dependaBot PR
    runs-on: ubuntu-latest
    steps:
      - name: Get current date
        id: date
        run: echo "CURRENT_DATE=$(date +'%Y-%m-%dT%H:%M:%S')" >> $GITHUB_ENV

      - name: Login to Jira
        uses: atlassian/gajira-login@ca13f8850ea309cf44a6e4e0c49d9aa48ac3ca4c # v3.0.1
        env:
          JIRA_BASE_URL: ${{ secrets.jira_base_url }}
          JIRA_USER_EMAIL: ${{ secrets.jira_user_email }}
          JIRA_API_TOKEN: ${{ secrets.jira_api_token }}

      - name: Create Jira Issue
        id: create
        uses: atlassian/gajira-create@1ff0b6bd115a780592b47bfbb63fc4629132e6ec # v3.0.1
        with:
          project: ${{ env.JIRA_PROJECT_KEY }}
          issuetype: ${{ env.JIRA_ISSUE_TYPE }}
          summary: Test Veracode creation
          description: |

            {panel:title=Recommandation}
              This is a ticket related to ${{ github.event.pull_request.title }}
            {panel}

            More details are available in the *PR nÂ°${{ github.event.pull_request.number }}*

            Github link is: ${{ github.event.pull_request.html_url }}

          fields:
            '{
              "customfield_10880": "Internal",
              "customfield_10881": "Veracode",
              "customfield_10866": "${{ env.CURRENT_DATE }}",
              "labels": ["Veracode", "Pipeline"],
              "components":[{"name": "centreon"}],
              "customfield_10902": "DevSecOps"
            }'

      - name: Log created issue
        run: echo "Issue ${{ steps.create.outputs.issue }} was created"
