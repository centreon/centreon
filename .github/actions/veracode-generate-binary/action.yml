name: "veracode-generate-binary"
description: "Prepare binary to be analyzed"
inputs:
  module_directory:
    description: Path to the module
    required: true
  module_name:
    description: Module name
    required: true
  target_branch_name:
    description: The target maintenance branch
    required: true
  cache_key:
    description: key used to identify the cache
    required: true

runs:
  using: "composite"
  steps:
    - name: Exclude development files
      # TODO: remove harmful chars from the file
      run: |
        ls -la
        if [[ -f ".veracode" ]]; then
          for LINE in $( cat .veracode ); do
            if [[ -d '$LINE' ]]; then
              rm -rf '$LINE'
            elif [[ -f '$LINE' ]]; then
              rm -f '$LINE'
            elif [[ -z '$LINE' ]]; then
              echo "DEBUG - unconsistent exclusion directive : $LINE"
            fi
          done
        else
          echo "DEBUG - No '.veracode' file found for this module. Skipping the exclusion directives"
        fi
      shell: bash

    - name: Create zip file
      run: |
        if [[ -z "${{ inputs.module_directory }}" || -z "${{ inputs.target_branch_name }}" || -z "${{ inputs.module_name }}" ]]; then
          echo "[DEBUG] - One mandatory argument is missing"
        fi
        cd ${{ inputs.module_directory }}
        zip -rq "../${{ inputs.module_name }}-${{ inputs.target_branch_name }}.zip" *
      shell: bash

    - uses: actions/cache/save@v3
      with:
        path: "${{ inputs.module_name }}-${{ inputs.target_branch_name }}.zip"
        key: ${{ inputs.cache_key }}
