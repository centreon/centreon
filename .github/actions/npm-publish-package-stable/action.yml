name: NPM publish
description: This publishes a package to NPM and creates a PR to update the package version

inputs:
  directory:
    description: The package directory
    required: true
  pat:
    description: The Github PAT
    required: true
  npm_token:
    description: The NPM token
    required: true
  package:
    description: The frontend package
    required: true
  tag:
    description: The tag version
    default: latest
  release_branch:
    description: The release branch
    required: true

runs:
  using: "composite"
  steps:
    - uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
      with:
        node-version: 20

    - uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
      with:
        version: 8

    - name: Install action dependencies
      run: pnpm install --frozen-lockfile
      working-directory: ./.github/actions/get-latest-npm-branch-version
      shell: bash

    - name: Get current package version
      id: currentVersion
      run: echo "current_package_version=`cat package.json | jq -r '.version'`" >> $GITHUB_OUTPUT
      shell: bash
      working-directory: ${{ env.directory }}

    - uses: ./.github/actions/get-latest-npm-branch-version
      id: get-latest-npm-branch-version
      with:
        package: ${{ inputs.package }}
        branch_name: ${{ inputs.release_branch }}
        current_package_version: ${{ steps.currentVersion.outputs.current_package_version }}

    - name: Write NPM package version
      if: ${{ steps.get-latest-npm-branch-version.outputs.package_version != '' && steps.get-latest-npm-branch-version.outputs.package_version != steps.currentVersion.outputs.current_package_version }}
      run: npm version ${{ steps.get-latest-npm-branch-version.outputs.package_version }} --legacy-peer-deps
      working-directory: ${{ env.directory }}
      shell: bash

    - name: Configure tag
      run: |
        echo "TAG=${{ inputs.tag }}" >> $GITHUB_ENV
      shell: bash

    - name: Bump NPM package version for develop
      if: ${{ steps.get-latest-npm-branch-version.outputs.skip-bump-version != 1 && github.ref_name == 'develop' }}
      run: |
        npm version patch --legacy-peer-deps
        VERSION=$(node -p "require('./package.json').version")
        rm ../../package-lock.json
        echo "VERSION=$VERSION" >> $GITHUB_ENV
      working-directory: ${{ env.directory }}
      shell: bash

    - name: Bump NPM package version for legacy versions
      if: ${{ steps.get-latest-npm-branch-version.outputs.skip-bump-version != 1 && startsWith(github.ref_name, 'dev-') }}
      run: |
        PREID=$(echo "${{ github.ref_name }}" | sed "s/\./-/g")
        npm version prerelease --preid $PREID --legacy-peer-deps
        VERSION=$(node -p "require('./package.json').version")
        rm ../../package-lock.json
        echo "VERSION=$VERSION" >> $GITHUB_ENV
      working-directory: ${{ env.directory }}
      shell: bash

    - name: Publish package to NPM (${{ env.TAG }})
      uses: JS-DevTools/npm-publish@19c28f1ef146469e409470805ea4279d47c3d35c # v3.1.1
      with:
        access: public
        package: ${{ env.directory }}/package.json
        tag: ${{ env.TAG }}
        token: ${{ inputs.npm_token }}
