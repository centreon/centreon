name: "Merge Artifacts"
description: "Merge Artifacts"
inputs:
  artifact_name:
    type: string
    required: true
  artifact_files:
    type: string
    required: true
  condition:
    type: boolean
    required: true
  github_token:
    required: true

runs:
  using: "composite"
  steps:
    - name: Download ${{ matrix.type_of_report }} Artifacts
      if: ${{ inputs.condition }}
      uses: actions/download-artifact@f44cd7b40bfd40b6aa1cc1b9b5b7bf03d3c67110 # v4.1.0
      with:
        pattern: ${{ inputs.artifact_name }}-*
        path: ${{ inputs.artifact_name }}
        merge-multiple: true

    - name: Upload the Regrouped Artifact
      if: ${{ inputs.condition }}
      uses: actions/upload-artifact@c7d193f32edcb7bfad88892161225aeda64e9392 # v4.0.0
      with:
        name: ${{ inputs.artifact_name }}
        path: |
          ${{ inputs.artifact_files }}
        retention-days: 1

    - name: Delete ${{ matrix.type_of_report }} Artifacts
      if: ${{ inputs.condition }}
      run: |
        artifact_pattern="${{ inputs.artifact_name }}-"
        TOKEN="${{ inputs.github_token }}"

        artifact_exist=true

        while [ "$artifact_exist" = true ] ;do
          artifact_exist=false
          artifacts_response=$(curl -L \
                        -H "Accept: application/vnd.github+json" \
                        -H "Authorization: Bearer $TOKEN" \
                        -H "X-GitHub-Api-Version: 2022-11-28" \
                        "https://api.github.com/repos/${{ github.repository }}/actions/artifacts?per_page=100")

          artifacts=$(echo $artifacts_response | jq -c '.artifacts[]')

          echo "Those are the artifacts : $artifacts"

          while read row; do
            artifact_name=$(echo "$row" | jq -r '.name')
            if [[ "$artifact_name" =~ ^.*"$artifact_pattern".* ]]; then
              artifact_exist=true
              echo "Deleting : $artifact_name"
              artifact_id=$(echo "$row" | jq -r '.id')
              # curl -L \
              #   -X DELETE \
              #   -H "Accept: application/vnd.github+json" \
              #   -H "Authorization: Bearer $TOKEN" \
              #   -H "X-GitHub-Api-Version: 2022-11-28" \
              #   "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/${artifact_id}"
            fi
          done <<< "$artifacts"
        done

        echo "End of Deleting"
      shell: bash
