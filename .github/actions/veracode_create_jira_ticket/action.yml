name: QG incident tracking
description: Create Jira ticket on Veracode QG failure

inputs:
  jira_base_url:
    required: true
    type: string
  jira_user_email:
    required: true
    type: string
  jira_api_token:
    required: true
    type: string

runs:
  using: "composite"
  steps:
    - name: Get current date
      id: date
      run: echo "CURRENT_DATE=$(date +'%Y-%m-%dT%H:%M:%S')" >> $GITHUB_ENV
      shell: bash

    - name: Login to Jira
      uses: atlassian/gajira-login@ca13f8850ea309cf44a6e4e0c49d9aa48ac3ca4c # v3.0.1
      env:
        JIRA_BASE_URL: ${{ inputs.jira_base_url }}
        JIRA_USER_EMAIL: ${{ inputs.jira_user_email }}
        JIRA_API_TOKEN: ${{ inputs.jira_api_token }}

    - name: Check if ticket exists already
      id: check-ticket
      run: |
        curl --request POST \
          --url '${{ inputs.jira_base_url }}/rest/api/3/search' \
          --user '${{ inputs.jira_user_email }}:${{ inputs.jira_api_token }}' \
          --header 'Accept: application/json' \
          --header 'Content-Type: application/json' \
          --data '{
          "fields": [
            "summary"
          ],
          "jql": "project = MON AND parentEpic = AT-268 AND issueType = Technical AND summary ~ \"PR-2967 on centreon/centreon\."",
          "maxResults": 1
        }' | jq .issues
      shell: bash

    - name: debug
      run: cat $GITHUB_OUTPUT
      shell: bash

    - name: Create Jira Issue
      if: ${{ steps.check-ticket.outputs.issue }} == 'skipMe'
      id: create
      uses: atlassian/gajira-create@1ff0b6bd115a780592b47bfbb63fc4629132e6ec # v3.0.1
      with:
        project: "MON"
        issuetype: "Technical"
        summary: Test Veracode creation
        description: |

          {panel:title=Recommandation}
            This is a ticket related to ${{ github.event.pull_request.title }}
          {panel}

          More details are available in the *PR nÂ°${{ github.event.pull_request.number }}*

          Github link is: ${{ github.event.pull_request.html_url }}

        fields:
          '{
            "customfield_10880": "Internal",
            "customfield_10881": "Veracode",
            "customfield_10866": "${{ env.CURRENT_DATE }}",
            "labels": ["Veracode", "Pipeline"],
            "components":[{"name": "centreon"}],
            "customfield_10902": "DevSecOps",
            "parentEpic": "AT-268"
          }'

    - name: Log created issue
      run: echo "[DEBUG] - Issue ${{ steps.create.outputs.issue }} was created"
      shell: bash
