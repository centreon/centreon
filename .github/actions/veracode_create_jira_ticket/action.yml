name: QG incident tracking
description: Create Jira ticket on Veracode QG failure

inputs:
  jira_base_url:
    required: true
    type: string
  jira_user_email:
    required: true
    type: string
  jira_api_token:
    required: true
    type: string
  module_name:
    required: true
    type: string

runs:
  using: "composite"
  steps:
    - name: Get current date
      id: date
      #run: echo "CURRENT_DATE=$(date +'%Y-%m-%dT%H:%M:%S')" >> $GITHUB_ENV
      run: echo "CURRENT_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      shell: bash

#    - name: Login to Jira
#      uses: atlassian/gajira-login@ca13f8850ea309cf44a6e4e0c49d9aa48ac3ca4c # v3.0.1
#      env:
#        JIRA_BASE_URL: ${{ inputs.jira_base_url }}
#        JIRA_USER_EMAIL: ${{ inputs.jira_user_email }}
#        JIRA_API_TOKEN: ${{ inputs.jira_api_token }}

    - name: Check if ticket exists already
      id: check-ticket
      run: |
        curl --request POST \
          --url '${{ inputs.jira_base_url }}/rest/api/3/search' \
          --user '${{ inputs.jira_user_email }}:${{ inputs.jira_api_token }}' \
          --header 'Accept: application/json' \
          --header 'Content-Type: application/json' \
          --data '{
          "fields": [
            "summary"
          ],
          "jql": "project = MON AND parentEpic = AT-268 AND issueType = Technical AND summary ~ \"PR-2967 on centreon/centreon\."",
          "maxResults": 1
        }' | jq .issues
      shell: bash

    - name: debug
      run: |
        cat $GITHUB_OUTPUT
        echo "[DEBUG] - ${{ steps.check-ticket.outputs.issue }}"
      shell: bash

    - name: Create Jira Issue
      id: create
      run: |
        DATA=$( cat <<-EOF
        {
          "fields": {
              "summary": "Test Veracode creation",
              "project": {"key": "MON"},
              "issuetype": {"id": "10209"},
              "parent": {"id": "83818", "key": "AT-268"},
              "labels": ["Veracode", "Pipeline"],
              "components":[{"name": "${{ inputs.module_name }}"}],
              "customfield_10902": {"id": "10524", "value": "DevSecOps"},
              "description": {
              "content": [
                {
                  "content": [
                    {
                      "text": "This ticket relates to ${{ github.event.pull_request.title }} \n{panel} \n More details are available in the following PR logs *${{ github.event.pull_request.number }}* \n Github link is: ${{ github.event.pull_request.html_url }}",
                      "type": "text"
                    }
                  ],
                  "type": "paragraph"
                }
              ],
              "type": "doc",
              "version": 1
            }
          }
        }
        EOF
        )

        curl --request POST \
          --url "${{ inputs.jira_base_url }}/rest/api/3/issue" \
          --user "${{ inputs.jira_user_email }}:${{ inputs.jira_api_token }}" \
          --header 'Accept: application/json' \
          --header 'Content-Type: application/json' \
          --data "$DATA"
      shell: bash

    - name: Log created issue
      run: |
        echo "[DEBUG] - Issue ${{ steps.create.outputs.issue }} was created"
        echo "[DEBUG] - Issue ${{ steps.create.outputs.id }} was created"
        echo "[DEBUG] - Issue ${{ steps.create.outputs.key }} was created"
      shell: bash
