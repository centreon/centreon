name: QG incident tracking
description: Create Jira ticket on Veracode QG failure

inputs:
  jira_base_url:
    required: true
    type: string
  jira_user_email:
    required: true
    type: string
  jira_api_token:
    required: true
    type: string
  module_name:
    required: true
    type: string

runs:
  using: "composite"
  steps:
    - name: Check if ticket exists already
      run: |
        check_if_ticket_exists=$( curl --request POST \
          --url '${{ inputs.jira_base_url }}/rest/api/3/search' \
          --user '${{ inputs.jira_user_email }}:${{ inputs.jira_api_token }}' \
          --header 'Accept: application/json' \
          --header 'Content-Type: application/json' \
          --data '{
          "fields": [
            "summary"
          ],
          "jql": "project = MON AND parentEpic = AT-268 AND issueType = Technical AND summary ~ \"PR-${{ github.event.pull_request.number }} incident on ${{ inputs.module_name }}\"",
          "maxResults": 1
        }' | jq .issues )
        if [[ -n "$check_if_ticket_exists" ]]; then
          echo "abort_ticket_creation=true" >> GITHUB_ENV
          echo "::error::ticket found. Aborting ticket creation"
        fi
        echo "[DEBUG] - ticket is $check_if_ticket_exists"
      shell: bash

    - name: debug
      run: |
        echo "OUTPUT ="
        cat $GITHUB_OUTPUT
        echo "ENV ="
        cat $GITHUB_ENV
      shell: bash

    - name: Create Jira Issue
      if: $abort_ticket_creation != 'true'
      run: |
        title="PR-${{ github.event.pull_request.number }} incident on ${{ inputs.module_name }}"
        description="This ticket relates to ${{ github.event.pull_request.title }}\n\nMore details are available in the PR-${{ github.event.pull_request.number }} logs\n\nGithub link:\n${{ github.event.pull_request.html_url }}"
        DATA=$( cat <<-EOF
        {"fields": {
          "summary": "${title}", "project": {"key": "MON"}, "issuetype": {"id": "10209"},
          "parent": {"id": "83818", "key": "AT-268"}, "labels": ["Veracode", "Pipeline"],
          "components":[{"name": "${{ inputs.module_name }}"}],
          "customfield_10902": {"id": "10524", "value": "DevSecOps"},
          "description": {"content": [{"content": [{"text": "${description}","type": "text"}],"type": "paragraph"}],"type": "doc","version": 1}}}
        EOF
        )

        created_ticket_id=$( curl --request POST \
          --url "${{ inputs.jira_base_url }}/rest/api/3/issue" \
          --user "${{ inputs.jira_user_email }}:${{ inputs.jira_api_token }}" \
          --header 'Accept: application/json' \
          --header 'Content-Type: application/json' \
          --data "$DATA" | jq .key )
        echo "::warning::Incident ticket created as $created_ticket_id"
      shell: bash
