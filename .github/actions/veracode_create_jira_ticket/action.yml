name: QG incident tracking
description: Create Jira ticket on Veracode QG failure

inputs:
  jira_base_url:
    required: true
    type: string
  jira_user_email:
    required: true
    type: string
  jira_api_token:
    required: true
    type: string
  module_name:
    required: true
    type: string

runs:
  using: "composite"
  steps:
    - name: Get current date
      id: date
      #run: echo "CURRENT_DATE=$(date +'%Y-%m-%dT%H:%M:%S')" >> $GITHUB_ENV
      run: echo "CURRENT_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
      shell: bash

    - name: Check if ticket exists already
      id: check-ticket
      run: |
        check_ticket_id=$( curl --request POST \
          --url '${{ inputs.jira_base_url }}/rest/api/3/search' \
          --user '${{ inputs.jira_user_email }}:${{ inputs.jira_api_token }}' \
          --header 'Accept: application/json' \
          --header 'Content-Type: application/json' \
          --data '{
          "fields": [
            "summary"
          ],
          "jql": "project = MON AND parentEpic = AT-268 AND issueType = Technical AND summary ~ \"${{ github.event.pull_request.number }} incident on ${{ inputs.module_name }} pipeline\"",
          "maxResults": 1
        }' | jq .issues )
        echo "::error::ticket found ? $check_ticket_id"
      shell: bash

    - name: debug
      run: |
        cat $GITHUB_OUTPUT
        echo "[DEBUG] - ${{ steps.check-ticket.outputs.issue }}"
      shell: bash

    - name: Create Jira Issue
      id: create
      run: |
        DATA=$( cat <<-EOF
        {
          "fields": {
              "summary": "${{ github.event.pull_request.number }} incident on ${{ inputs.module_name }} pipeline",
              "project": {"key": "MON"},
              "issuetype": {"id": "10209"},
              "parent": {"id": "83818", "key": "AT-268"},
              "labels": ["Veracode", "Pipeline"],
              "components":[{"name": "${{ inputs.module_name }}"}],
              "customfield_10902": {"id": "10524", "value": "DevSecOps"},
              "description": {
              "content": [
                {
                  "content": [
                    {
                      "text": "This ticket relates to ${{ github.event.pull_request.title }} \n\n More details are available in the following PR logs ** ${{ github.event.pull_request.number }} ** \n Github link is:\n ${{ github.event.pull_request.html_url }}",
                      "type": "text"
                    }
                  ],
                  "type": "paragraph"
                }
              ],
              "type": "doc",
              "version": 1
            }
          }
        }
        EOF
        )

        created_ticket_id=$( curl --request POST \
          --url "${{ inputs.jira_base_url }}/rest/api/3/issue" \
          --user "${{ inputs.jira_user_email }}:${{ inputs.jira_api_token }}" \
          --header 'Accept: application/json' \
          --header 'Content-Type: application/json' \
          --data "$DATA" ) | jq .key
        echo "::warning::Incident ticket created as $created_ticket_id"
      shell: bash
