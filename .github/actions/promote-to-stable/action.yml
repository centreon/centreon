name: "promote testing to stable"
description: "Promote testing packages to stable."
inputs:
  artifactory_token:
    description: "Artifactory token"
    required: true
  module:
    description: "Module"
    required: true
  distrib:
    description: "The distribution used for packaging"
    required: true
  major_version:
    description: "Centreon packaged major version"
    required: true
  minor_version:
    description: "Centreon package minor version"
    required: true
  stability:
    description: "The package stability (stable, testing, unstable)"
    required: true

runs:
  using: "composite"
  steps:
    - uses: jfrog/setup-jfrog-cli@v3
      env:
        JF_URL: https://centreon.jfrog.io
        JF_ACCESS_TOKEN: ${{ inputs.artifactory_token }}

    - name: Promote package
      run: |
        echo "[DEBUG] - Promote to repository: ${{ inputs.stability }}"
        TARGET_PATH="rpm-standard/${{ inputs.version }}/${{ inputs.distrib }}/${{ inputs.stability }}/noarch/RPMS/"
        echo "[DEBUG] - Target path: $TARGET_PATH"

        echo "[DEBUG] - Get path to dir with testing artifacts to promote to stable."
        SRC_PATH=$(jf rt s --include-dirs --fail-no-op rpm-standard/${{ inputs.version }}/${{ inputs.distrib }}/testing/noarch/${{ inputs.module }}/centreon-${{ inputs.module }}-${{ inputs.major_version }}.${{ inputs.minor_version }}-1.${{ inputs.distrib }}.noarch.rpm | jq -r '.[].path')
        echo "[DEBUG] - Source path: $SRC_PATH"

        echo "[DEBUG] - Promoting RPM testing artifacts to stable."
        jf rt cp --flat=true $SRC_PATH/* $TARGET_PATH/


      shell: bash
