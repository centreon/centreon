name: "Publish to NPM public repository"
description: "Publishes a package to NPM public repository"

inputs:
  package:
    description: The package to publish
    required: true
  release_branch:
    description: The release branch
    required: true

runs:
  using: "composite"
  steps:
    - uses: actions/setup-node@v3
      with:
        node-version: 17

    - name: Update JS config version
      run: |
        git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
        git config user.name "$GITHUB_ACTOR"
        git config pull.rebase false
        echo ${{ github.ref_name }}
        [ ${{ github.ref_name }} == ${{ inputs.release_branch }} ] && npm version patch --legacy-peer-deps || npm version prerelease --preid ${{ github.head_ref || github.ref_name }} --legacy-peer-deps
        VERSION=${{ inputs.package }}-$(node -p "require('./package.json').version")
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        git pull
        git add .
        git commit -m "chore: pre-release ${VERSION}"
      working-directory: ${{ env.directory }}

    - name: Tag release
      if: github.ref == inputs.release_branch
      run: git tag ${{ env.VERSION }}

    - name: Push changes to repository
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: git push origin ${{ github.ref_name }}

    - name: Push with tags
      if: github.ref == inputs.release_branch
      run: git push --tags

    - uses: JS-DevTools/npm-publish@v1
      if: startsWith(github.ref, 'refs/heads/MON')
      with:
        token: ${{ secrets.NPM_TOKEN }}
        package: ${{ env.directory }}/package.json
        tag: ${{ env.VERSION }}
        access: public

    - uses: JS-DevTools/npm-publish@v1
      if: github.ref == 'refs/heads/develop'
      with:
        token: ${{ secrets.NPM_TOKEN }}
        package: ${{ env.directory }}/package.json
        tag: latest
        access: public
