name: "setup docker"
description: "Install docker and docker-compose"

runs:
  using: "composite"
  steps:
    - name: Install docker
      run: |
        repo_url="https://download.docker.com/linux/ubuntu"
        gpg_key="/usr/share/keyrings/docker.gpg"
        repo_path="/etc/apt/sources.list.d/docker.list"
        sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o $gpg_key
        sudo echo "deb [arch=amd64 signed-by=$gpg_key] $repo_url $(lsb_release -cs) stable" | sudo tee $repo_path

        sudo apt-get update
        sudo apt-get install -y --no-install-recommends docker-ce docker-ce-cli containerd.io docker-buildx-plugin

        #sudo systemctl stop apparmor
        sudo apt install policycoreutils selinux-basics selinux-utils -y
        sudo selinux-activate
        #sudo setenforce 1
        #sudo setsebool container_manage_cgroup 1
        sudo getenforce

        docker info
      shell: bash

    - name: Install docker-compose
      run: |
        # Install docker compose v2 from releases
        sudo curl -fsSL https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-$(uname -s)-$(uname -m) -o /usr/libexec/docker/cli-plugins/docker-compose
        sudo chmod +x /usr/libexec/docker/cli-plugins/docker-compose

        docker-compose -v
      shell: bash

    - name: Restart docker daemon
      continue-on-error: true
      run: |
        docker info

        ip addr

        cat /etc/docker/daemon.json

        sudo bash -c 'cat <<EOF >/etc/docker/daemon.json
        {
          "registry-mirrors": [
            "https://docker.centreon.com"
          ],
          "ip": "0.0.0.0",
          "ip-forward": true,
          "mtu": 0,
          "proxies": {
            "http-proxy": "",
            "https-proxy": "",
            "no-proxy": "*"
          },
          "selinux-enabled": true
        }
        EOF'

        #"exec-opts": ["native.cgroupdriver=cgroupfs"],
        #"cgroup-parent": "/actions_job"
        #
        #

        cat /etc/docker/daemon.json

        sleep 60

        sudo pkill dockerd || true
        sudo rm -f /var/run/docker.pid || true

        sleep 30
        sudo pkill dockerd || true
        sudo rm -f /var/run/docker.pid || true

        sudo bash -c "/usr/bin/dockerd & > /dev/null 2>&1" || true

        docker info

        ip addr
      shell: bash
