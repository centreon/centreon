name: "package version"
description: "version package"
inputs:
  module_name:
    description: "The package module name"
    required: true
outputs:
  minor_version:
    description: "minor version"
    value: ${{ steps.minor.outputs.minor_version }}
  release:
    description: "release"
    value: ${{ steps.minor.outputs.release }}

runs:
  using: "composite"
  steps:
    - name: get package version
      id: minor
      run: |
        if [[ -z "$GITHUB_HEAD_REF" ]];
        then
          BRANCHNAME="$GITHUB_REF_NAME"
        else
          BRANCHNAME="$GITHUB_HEAD_REF"
        fi
        case "$BRANCHNAME" in
          master)
            echo "minor_version=0" >> $GITHUB_OUTPUT
            echo "release=0" >> $GITHUB_OUTPUT
            ;;
          release* | hotfix* | [2-9][0-9].[0-9][0-9].*)
            MAJOR_VERSION=$(echo "$GITHUB_REF_NAME" | grep -oP '([0-9]{2}\.[0-9]{2})')
            OLDV=$(git tag --sort=-v:refname --list "centreon-${{ inputs.module_name }}-$MAJOR_VERSION*" | head -n 1)
            if [ -z "$OLDV" ]; then
              echo "minor_version=0" >> $GITHUB_OUTPUT
              echo "release=0" >> $GITHUB_OUTPUT
            else
              echo "minor_version=$(echo $OLDV | grep -oP '([0-9]+$)')+1" >> $GITHUB_OUTPUT
              echo "release=0" >> $GITHUB_OUTPUT
            fi
            ;;
          *)
            echo "minor_version=0" >> $GITHUB_OUTPUT
            echo "release=`date +%s`.${{ github.sha }}" >> $GITHUB_OUTPUT
            ;;
        esac
      shell: bash