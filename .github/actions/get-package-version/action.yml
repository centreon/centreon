name: "package version"
description: "version package"
inputs:
  module_name:
    description: "The package module name"
    required: true
outputs:
  minor_version:
    description: "minor version"
    value: ${{ steps.minor.outputs.minor_version }}
  release:
    description: "release"
    value: ${{ steps.minor.outputs.release }}

runs:
  using: "composite"
  steps:
    - name: get package version
      id: minor
      run: |
        if [[ -z "$GITHUB_HEAD_REF" ]];
        then
          export "BRANCHNAME"="$GITHUB_REF_NAME"
        else
          export "BRANCHNAME"="$GITHUB_HEAD_REF"
        fi
        case "$BRANCHNAME" in
          MON* | dev*)
            echo "::set-output name=minor_version::0"
            echo "::set-output name=release::`date +%s`.${{ github.sha }}"
            ;;
          master)
            echo "::set-output name=minor_version::0"
            echo "::set-output name=release::0"
            ;;
          release* | hotfix*)
            MAJOR_VERSION=$(echo $GITHUB_REF_NAME | grep -oP '([0-9]{2}\.[0-9]{2})')
            OLDV=$(git tag --sort=-v:refname --list "centreon-${{ inputs.module_name }}-$MAJOR_VERSION*" | head -n 1)
            if [ -z "$OLDV" ]; then
              echo "::set-output name=minor_version::0"
              echo "::set-output name=release::0"
            else
              echo "::set-output name=minor_version::$(echo $OLDV | grep -oP '([0-9]+$)')+1"
              echo "::set-output name=release::0"
            fi
            ;;
          ^[0-9]{2}\.[0-9]{2}.)
            MAJOR_VERSION=$(echo $GITHUB_REF_NAME | grep -oP '([0-9]{2}\.[0-9]{2})')
            OLDV=$(git tag --sort=-v:refname --list "centreon-${{ inputs.module_name }}-$MAJOR_VERSION*" | head -n 1)
            if [ -z "$OLDV" ]; then
              echo "::set-output name=minor_version::0"
              echo "::set-output name=release::0"
            else
              echo "::set-output name=minor_version::$(echo $OLDV | grep -oP '([0-9]+$)')"
              echo "::set-output name=release::0"
            fi
            ;;
          *)
            echo -n "[INFO] Non conventional branch name. Please rename your branch to meet the requirements"
            echo $GITHUB_HEAD_REF
            exit 1
            ;;
        esac
      shell: bash