name: "package version"
description: "version package"
inputs:
  module_name:
    description: "The package module name"
    required: true
outputs:
  minor_version:
    description: "minor version"
    value: ${{ steps.minor.outputs.minor_version }}
  release:
    description: "release"
    value: ${{ steps.minor.outputs.release }}

runs:
  using: "composite"
  steps:
    - name: get package version
      id: minor
      run: |
        if [[ -z "$GITHUB_HEAD_REF" ]];
        then
          BRANCHNAME=$GITHUB_REF_NAME
        else
          BRANCHNAME=$GITHUB_HEAD_REF
        fi

        echo $BRANCHNAME

        case "$BRANCHNAME" in
          MON* | dev*)
            echo "minor_version=0" >> $GITHUB_OUTPUT
            echo "release=`date +%s`.${{ github.sha }}" >> $GITHUB_OUTPUT
            ;;
          master)
            echo "minor_version=0" >> $GITHUB_OUTPUT
            echo "release=0" >> $GITHUB_OUTPUT
            ;;
          release* | hotfix*)
            echo "in release or hotfix"
            MAJOR_VERSION=$(echo $BRANCHNAME | grep -oP '([0-9]{2}\.[0-9]{2})')
            echo "major version : $MAJOR_VERSION"
            OLD_VERSION=$(git tag --sort=-v:refname --list "centreon-${{ inputs.module_name }}-$MAJOR_VERSION*" | head -n 1)
            echo "old version : $OLD_VERSION"
            if [ -z "$OLD_VERSION" ]; then
              echo "minor_version=0" >> $GITHUB_OUTPUT
              echo "release=0" >> $GITHUB_OUTPUT
            else
              echo "minor_version=$(echo $OLD_VERSION | grep -oP '([0-9]+$)')+1" >> $GITHUB_OUTPUT
              echo "release=0" >> $GITHUB_OUTPUT
            fi
            ;;
          ^[0-9]{2}\.[0-9]{2}.)
            MAJOR_VERSION=$(echo $BRANCHNAME | grep -oP '([0-9]{2}\.[0-9]{2})')
            OLD_VERSION=$(git tag --sort=-v:refname --list "centreon-${{ inputs.module_name }}-$MAJOR_VERSION*" | head -n 1)
            if [ -z "$OLD_VERSION" ]; then
              echo "minor_version=0" >> $GITHUB_OUTPUT
              echo "release=0" >> $GITHUB_OUTPUT
            else
              echo "minor_version=$(echo $OLD_VERSION | grep -oP '([0-9]+$)')" >> $GITHUB_OUTPUT
              echo "release=0" >> $GITHUB_OUTPUT
            fi
            ;;
          *)
            echo -n "[INFO] Non conventional branch name. Please rename your branch to meet the requirements"
            echo $GITHUB_HEAD_REF
            exit 1
            ;;
        esac
      shell: bash