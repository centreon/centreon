name: "Package Widgets Centreon"
description: "Test Centreon"
inputs:
  distrib_redhat:
    description: "distrib_redhat"
    required: false
  distrib_debian:
    description: "distrib_debian"
    required: false
  project:
    description: "project"
    required: true
  distrib_rpm:
    description: "distrib rpm"
    required: false
  distrib_deb:
    description: "distrib deb"
    required: false
  module_name:
    description: "module name"
    required: true
runs:
  using: "composite"
  steps:
    - name: Use cache RPM files
      uses: actions/cache@v3
      env:
        cache-name-rpmbuild: cache-${{ github.sha }}-${{ github.run_id }}-rpmbuild-${{ inputs.module_name}}
      with:
        path: ./*.rpm
        key: ${{ env.cache-name-rpmbuild }}-${{ inputs.distrib_rpm }}
        restore-keys: |
          ${{ env.cache-name-rpmbuild }}-${{ inputs.distrib_rpm }}

    - name: build docker ${{ inputs.project }} ${{ inputs.distrib_redhat }}
      if: ${{ inputs.distrib_redhat }}
      run: docker build --no-cache . -f .github/docker/Dockerfile.${{ inputs.module_name }}-package-${{ inputs.distrib_rpm }} -t registry-docker.centreon.com/docker-global/${{ inputs.module_name }}-package-${{ inputs.distrib_rpm }}:${{ github.head_ref || github.ref_name }}
      shell: bash

    - name: build docker ${{ inputs.project }} ${{ inputs.distrib_debian }}
      if: ${{ inputs.distrib_debian }}
      run: docker build --no-cache . -f .github/docker/Dockerfile.${{ inputs.module_name }}-package-${{ inputs.distrib_deb }} -t registry-docker.centreon.com/docker-global/${{ inputs.module_name }}-package-${{ inputs.distrib_deb }}:${{ github.head_ref || github.ref_name }}
      shell: bash

    - name: run docker ${{ inputs.project }} ${{ inputs.distrib_redhat }}
      if: ${{ inputs.distrib_redhat }}
      run: docker run -it -d --privileged --name ${{ inputs.module_name }}-package-${{ inputs.distrib_rpm }} registry-docker.centreon.com/docker-global/${{ inputs.module_name }}-package-${{ inputs.distrib_rpm }}:${{ github.head_ref || github.ref_name }}
      shell: bash

    - name: run docker ${{ inputs.project }} ${{ inputs.distrib_debian }}
      if: ${{ inputs.distrib_debian }}
      run: docker run -it -d --privileged --name ${{ inputs.module_name }}-package-${{ inputs.distrib_deb }} registry-docker.centreon.com/docker-global/${{ inputs.module_name }}-package-${{ inputs.distrib_deb }}:${{ github.head_ref || github.ref_name }}
      shell: bash

    - name: commit docker ${{ inputs.project }} ${{ inputs.distrib_redhat }}
      if: ${{ inputs.distrib_redhat }}
      run: docker commit ${{ inputs.module_name }}-package-${{ inputs.distrib_rpm }} registry-docker.centreon.com/docker-global/${{ inputs.module_name }}-package-${{ inputs.distrib_rpm }}:${{ github.head_ref || github.ref_name }}
      shell: bash

    - name: commit docker ${{ inputs.project }} ${{ inputs.distrib_debian }}
      if: ${{ inputs.distrib_debian }}
      run: docker commit ${{ inputs.module_name }}-package-${{ inputs.distrib_deb }} registry-docker.centreon.com/docker-global/${{ inputs.module_name }}-package-${{ inputs.distrib_deb }}:${{ github.head_ref || github.ref_name }}
      shell: bash

    - name: push docker ${{ inputs.project }} ${{ inputs.distrib_redhat }}
      if: ${{ inputs.distrib_redhat }}
      run: docker push registry-docker.centreon.com/docker-global/${{ inputs.module_name }}-package-${{ inputs.distrib_rpm }}:${{ github.head_ref || github.ref_name }}
      shell: bash

    - name: push docker ${{ inputs.project }} ${{ inputs.distrib_debian }}
      if: ${{ inputs.distrib_debian }}
      run: docker push registry-docker.centreon.com/docker-global/${{ inputs.module_name }}-package-${{ inputs.distrib_deb }}:${{ github.head_ref || github.ref_name }}
      shell: bash
