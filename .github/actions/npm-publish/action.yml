name: NPM publish
description: This publishes a package to NPM and creates a PR to update the package version

inputs:
  directory:
    description: The package directory
    required: true
  pat:
    description: The Github PAT
    required: true
  npm_token:
    description: The NPM token
    required: true
  package:
    description: The frontend package
    required: true
  version:
    description: The version
    default: latest
  release_branch:
    description: The release branch
    required: true

runs:
  using: "composite"
  steps:
    - uses: actions/setup-node@v3
      with:
        node-version: 17

    - name: Is this a release?
      run: |
        [ ${{ github.event.pull_request.merged == true && !startsWith(github.head_ref, 'MON-update-package-versions') }} ] && echo "IS_RELEASE=true" >> $GITHUB_ENV || echo "IS_RELEASE=false" >> $GITHUB_ENV

    - name: Update JS config version
      run: |
        echo ${{ env.IS_RELEASE }}
        [ ${{ env.IS_RELEASE }} ] && npm version patch --legacy-peer-deps || npm version prerelease --preid ${{ github.head_ref }} --legacy-peer-deps
        VERSION=$(node -p "require('./package.json').version")
        rm ../../package-lock.json
        echo "VERSION=$VERSION" >> $GITHUB_ENV
      working-directory: ${{ env.directory }}
      shell: bash

    - name: Configure git
      run: |
        git config user.email "technique-ci@centreon.com"
        git config user.name "technique-ci"
      shell: bash

    # - name: Commit and push changes
    #   if: ${{ startsWith(github.head_ref, 'MON') && !startsWith(github.head_ref, 'MON-update-package-versions') }}
    #   run: |
    #     git add .
    #     git commit -m "chore: pre-release ${VERSION}"
    #     git push origin ${{ github.head_ref }}

    # - uses: JS-DevTools/npm-publish@v1
    #   if: ${{ !env.IS_RELEASE }}
    #   with:
    #     access: public
    #     package: ${{ env.directory }}/package.json
    #     tag: ${{ github.head_ref }}
    #     token: ${{ inputs.npm_token }}

    # - uses: JS-DevTools/npm-publish@v1
    #   if: ${{ env.IS_RELEASE }}
    #   with:
    #     access: public
    #     package: ${{ env.directory }}/package.json
    #     tag: ${{ inputs.version }}
    #     token: ${{ inputs.npm_token }}

    # - name: Create Pull Request
    #   uses: peter-evans/create-pull-request@v4
    #   if: ${{ env.IS_RELEASE }}
    #   with:
    #     token: ${{ inputs.pat }}
    #     committer: Technique CI <technique-ci@centreon.com>
    #     author: technique-ci <technique-ci@centreon.com>
    #     branch: MON-update-package-versions-${{ inputs.package }}-${{ env.VERSION }}
    #     title: "chore(${{ inputs.package }} version): Update package ${{ inputs.package }} version to ${{ env.VERSION }}"
    #     body: |
    #       This updates the ${{ inputs.package }} package version to ${{ env.VERSION }}.
    #       This is an automatic PR.
    #     labels: |
    #       automerge
    #     draft: false
    #     signoff: true
    #     delete-branch: true