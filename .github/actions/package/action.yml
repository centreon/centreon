name: package
description: Package module
inputs:
  package_extension:
    description: The package extension (deb or rpm)
    required: true
  frontend_index_cache_key:
    description: The index.html cache key
  frontend_index_file:
    description: The index.html file path
  frontend_static_cache_key:
    description: The static directory cache key
  frontend_static_directory:
    description: The static directory
  backend_vendor_cache_key:
    description: The vendor directory cache key
  backend_vendor_directory:
    description: The vendor directory
  translation_cache_key:
    description: The translation directory cache key
  translation_directory:
    description: The translation directory
  image_name:
    description: The action matrix
    required: true
  script_name:
    description: The packaging script name
  module_name:
    description: The module name
    required: true
  major_version:
    description: The major version
    required: true
  minor_version:
    description: The minor version
    required: true
  release:
    description: The release number
    required: true
  cache_key:
    description: The package files cache key
    required: true

runs:
  using: composite

  steps:
    - name: Restore index file cache
      if: "${{ inputs.frontend_index_file != '' && inputs.frontend_index_cache_key != '' }}"
      uses: actions/cache@v3
      with:
        path: ${{ inputs.frontend_index_file }}
        key: ${{ inputs.frontend_index_cache_key }}

    - name: Restore static directory cache
      if: "${{ inputs.frontend_static_directory != '' && inputs.frontend_static_cache_key != '' }}"
      uses: actions/cache@v3
      with:
        path: ${{ inputs.frontend_static_directory }}
        key: ${{ inputs.frontend_static_cache_key }}

    - name: Restore vendor directory cache
      if: "${{ inputs.backend_vendor_directory != '' && inputs.backend_vendor_cache_key != '' }}"
      uses: actions/cache@v3
      with:
        path: ${{ inputs.backend_vendor_directory }}
        key: ${{ inputs.backend_vendor_cache_key }}

    - name: Restore translation directory cache
      if: "${{ inputs.translation_directory != '' && inputs.translation_cache_key != '' }}"
      uses: actions/cache@v3
      with:
        path: ${{ inputs.translation_directory }}
        key: ${{ inputs.translation_cache_key }}

    - if: ${{ inputs.package_extension == 'rpm' }}
      run: |
        set -x

        VERSION=${{ inputs.major_version }}.${{ inputs.minor_version }}
        RELEASE=${{ inputs.release }}

        if [ ! -d ~/rpmbuild/SOURCES ] ; then
            mkdir -p ~/rpmbuild/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
        fi

        mkdir centreon-$VERSION
        cp -rp centreon centreon-$VERSION/
        ls -l centreon-$VERSION/centreon/
        tar czf ~/rpmbuild/SOURCES/centreon-$VERSION.tar.gz centreon-$VERSION

        cp -rp centreon/packaging/src/* ~/rpmbuild/SOURCES/
        mv ~/rpmbuild/SOURCES/centreon-macroreplacement.centos7.txt ~/rpmbuild/SOURCES/centreon-macroreplacement.txt

        rpmbuild -ba centreon/packaging/centreon.spectemplate -D "VERSION $VERSION" -D "REL $RELEASE"

        cp -r ~/rpmbuild/RPMS/noarch/*.rpm .
        chmod 777 *.rpm
      shell: bash

    - if: ${{ inputs.package_extension == 'deb' }}
      run: |
        set -x

        VERSION=${{ inputs.major_version }}.${{ inputs.minor_version }}
        RELEASE=${{ inputs.release }}

        tar czpvf centreon-$VERSION.tar.gz centreon
        cd centreon
        cp -rp packaging/debian .

        sed -i "s/^centreon:version=.*$/centreon:version=$(echo $VERSION | egrep -o '^[0-9][0-9].[0-9][0-9]')/" debian/substvars
        debmake -f "Centreon" -e "contact@centreon.com" -u "$VERSION" -y -r "bullseye"
        debuild-pbuilder --no-lintian
      shell: bash

#    - name: Sign
#      if: ${{ inputs.sign != '' && inputs.package_extension == 'rpm' }}
#      uses: ./.github/actions/runner-docker
#      with:
#        script_name: rpm-signing
#        image_name: rpm-signing
#        image_version: ubuntu

    - name: Cache packaged files
      uses: actions/cache@v3
      with:
        path: ./*.${{ inputs.package_extension }}
        key: ${{ inputs.cache_key }}
