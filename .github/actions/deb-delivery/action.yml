name: "deb-package"
description: "Package DEB Centreon"
inputs:
  module_name:
    description: "The package module name"
    required: true
  distrib:
    description: "The distribution used for packaging"
    required: true
  nexus_username:
    description: "Artifact Manager technical username"
    required: true
  nexus_password:
    description: "Artifact Manager technical password"
    required: true
  version:
    description: "Centreon packaged version"
    required: true
  cache_key:
<<<<<<< HEAD
    description: "The cached RPM key"
=======
    description: "The cached package key"
>>>>>>> develop
    required: true

runs:
  using: "composite"
  steps:
    - name: Use cache DEB files
      uses: actions/cache@v3
      with:
        path: ./*.deb
        key: ${{ inputs.cache_key }}

<<<<<<< HEAD
    - name: Publish DEB to Nexus
=======
    - name: Publish DEBS to Nexus
>>>>>>> develop
      run: |
        if [[ -z "$GITHUB_HEAD_REF" ]];
        then
          BRANCHNAME=$GITHUB_REF_NAME
        else
          BRANCHNAME=$GITHUB_HEAD_REF
        fi

        echo "[DEBUG] - Branch name: $BRANCHNAME"

        case "$BRANCHNAME" in
          develop)
            REPO=unstable
            ;;
          release* | hotfix*)
            REPO=testing
            ;;
          master | [0-9]{2}\.[0-9]{2}.)
            REPO=stable
            ;;
          MON*)
            echo -n "[INFO] NO DELIVERY ON MON BRANCHES"
            exit 0
            ;;
          *)
            echo -n "[INFO] Non conventional branch name. Please rename your branch to meet the requirements"
            echo $GITHUB_HEAD_REF
            exit 1
            ;;
        esac

        FILES="*.deb";
        echo "[DEBUG] - Repo: $REPO"
        echo "[DEBUG] - Deb FILES: $FILES"

        for FILE in $FILES
        do
          echo "[DEBUG] - File: $FILE"

<<<<<<< HEAD
          VERSION=$(echo $FILE | grep -oP '[0-9]{2}\.[0-9]{2}')
          DISTRIB=${{ matrix.distrib }}
          ARCH=$(echo $FILE | grep -oP '(amd64)')
          MODULE=$(echo $FILE | grep -oP 'centreon-([a-z]+)')

          echo "Repo: $REPO"
          echo "Version: $VERSION"
          echo "Distrib: $DISTRIB"
          echo "Arch: $ARCH"
          echo "Module: $MODULE"
=======
          VERSION=${{ inputs.version }}

          echo "[DEBUG] - Version: $VERSION"
>>>>>>> develop

          curl -v -u ${{ inputs.nexus_username }}:${{ inputs.nexus_password }} -H "Content-Type: multipart/form-data" --data-binary "@./$FILE" "http://nexus-svc.nexus.svc.cluster.local:8081/repository/$VERSION-$REPO/"
        done
      shell: bash
