name: "rpm-package"
description: "Package RPM Centreon"
inputs:
  module_name:
    description: "The package module name"
    required: true
  distrib:
    description: "The distribution used for packaging"
    required: true
  nexus_username: 
    description: "Artifact Manager technical username"
    required: true
  nexus_password:
    description: "Artifact Manager technical password"
    required: true
  version:
    description: "Centreon packaged version"
    required: true
  

runs:
  using: "composite"
  steps:
    - name: Use cache RPM files
      uses: actions/cache@v3
      env:
        cache-name-rpmbuild: cache-${{ github.sha }}-${{ github.run_id }}-rpmbuild-${{ inputs.module_name }}-${{ inputs.distrib }}
      with:
        path: ./*.rpm
        key: ${{ env.cache-name-rpmbuild }}
        restore-keys: |
          ${{ env.cache-name-rpmbuild }}

    - name: Publish RPMS to Nexus
      run: |
        if [[ -z "$GITHUB_HEAD_REF" ]];
        then
          export "BRANCHNAME"="$GITHUB_REF_NAME"
        else
          export "BRANCHNAME"="$GITHUB_HEAD_REF"
        fi
        case "$BRANCHNAME" in
          develop)
            REPO=unstable
            ;;
          release* | hotfix*)
            REPO=testing
            ;;
          master | [0-9]{2}\.[0-9]{2}.)
            REPO=stable
            ;;
          MON*)
            echo -n "[INFO] NO DELIVERY ON MON BRANCHES"
            exit 0
            ;;
          *)
            echo -n "[INFO] Non conventional branch name. Please rename your branch to meet the requirements"
            echo $GITHUB_HEAD_REF
            exit 1
            ;;
        esac

        for FILE in *.rpm;
        do
          echo "[DEBUG] - Parsing file: $FILE"

          VERSION=${{ inputs.version }}
          DISTRIB=$(echo $FILE | grep -oP 'el[0-9]' | tail -1)
          ARCH=$(echo $FILE | grep -oP '(x86_64|noarch)')
          MODULE=$(echo $FILE | grep -oP 'centreon-\K([a-z]+)-([a-z]+)')

          echo "[DEBUG] - Repo:    $REPO"
          echo "[DEBUG] - Version: $VERSION"
          echo "[DEBUG] - Distrib: $DISTRIB"
          echo "[DEBUG] - Arch:    $ARCH"
          echo "[DEBUG] - Module:  $MODULE"

          curl -v -u ${{ inputs.nexus_username }}:${{ inputs.nexus_password }} --upload-file ./$FILE "http://nexus-svc.nexus.svc.cluster.local:8081/repository/standard/$VERSION/$DISTRIB/$REPO/$ARCH/$MODULE/"
        done
      shell: bash
