name: "check-version-consistency"
description: "Check consistency between given version and given file (install, update, .version...)."
inputs:
  file:
    description: The file to check for version consistency
    required: true
  version:
    description: The version to check against the file
    required: true

runs:
  using: "composite"
  steps:
    - name: Check version consistency
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
      env:
        VERSION: ${{ inputs.version }}
        FILE: ${{ inputs.file }}
      with:
        script: |
          const fs = require('fs');
          const filePath = process.env.FILE;
          const version = process.env.VERSION;

          if (!fs.existsSync(filePath)) {
            core.setFailed(`File ${filePath} does not exist.`);
            return;
          }

          if (filePath.match(/insertBaseConf\.sql$/)) {
            const content = fs.readFileSync(filePath);
            const matches = content.match(/\('version',\s*'([^']+)'\)/);

            if (!matches || matches.length < 2) {
              core.setFailed(`Version not found in ${filePath}.`);
              return;
            }

            if (version !== matches[1]) {
              core.setFailed(`Version mismatch: expected ${version}, found ${matches[1]} in ${filePath}.`);
              return;
            }

            console.log(`Version consistency check passed for ${filePath}.`);
          } else {
            // core.setFailed(`Unsupported file: ${filePath}`);
            return;
          }
