name: "Publish Lighthouse report to S3"
description: "Publish Lighthouse report to S3"
inputs:
  report_path:
    description: "report_path"
    required: true
  report_target:
    description: "report_target"
    required: true

runs:
  using: "composite"
  steps:
    - uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: "Setup AWS context"
      run: |
        sudo apt update -y
        sudo apt install -y unzip
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" 
        unzip awscliv2.zip
        sudo ./aws/install --update
        rm -rf awscliv2.zip aws
        BRANCH_NAME="develop"
        if [[ "$BRANCH_NAME" != "develop" && "$BRANCH_NAME" != "master" ]]; then
          VERSION=$(echo $BRANCH_NAME | grep -oE '([0-9]{2}\.[0-9]{2})').x
        else 
          VERSION=$BRANCH_NAME
        fi
        echo "VERSION=$VERSION" >> $GITHUB_ENV
      shell: bash

    - name: "Push report"
      run: |
        aws s3 cp "${{ inputs.report_path }}" "${{ inputs.report_target }}${{ env.VERSION }}/index.html" --acl public-read --region eu-west-1
      shell: bash
