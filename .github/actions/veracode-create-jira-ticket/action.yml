name: QG incident tracking
description: Create Jira ticket on Veracode QG failure

inputs:
  jira_base_url:
    required: true
    type: string
  jira_user_email:
    required: true
    type: string
  jira_api_token:
    required: true
    type: string
  module_name:
    required: true
    type: string

runs:
  using: "composite"
  steps:
    - name: Check if ticket exists already
      id: check_ticket
      run: |
        jq --version

        check_if_ticket_exists=$( curl --request POST \
          --url '${{ inputs.jira_base_url }}/rest/api/3/search' \
          --user '${{ inputs.jira_user_email }}:${{ inputs.jira_api_token }}' \
          --header 'Accept: application/json' \
          --header 'Content-Type: application/json' \
          --data '{
            "fields": ["summary"],
            "jql": "project = MON AND parentEpic = AT-268 AND issueType = Technical AND summary ~ \"PR-${{ github.event.pull_request.number }} incident on ${{ inputs.module_name }}\"",
            "maxResults": 1
        }' )

        echo "[DEBUG] - result = $check_if_ticket_exists"
        echo "[DEBUG] - check_if_ticket_exists = $( echo $check_if_ticket_exists | grep "key" : "MON-" )"

        if [[ -n "$check_if_ticket_exists" ]]; then
          echo "abort_ticket_creation=true" >> $GITHUB_ENV
          echo "::error::ticket found as $check_if_ticket_exists aborting ticket creation"
        fi

        echo "[DEBUG] - check_if_ticket_exists=${{ env.check_if_ticket_exists }}"
      shell: bash

    - name: Debug
      run: |
        echo "hello world"
        echo "[DEBUG] - env value is ${{ env.abort_ticket_creation }}"
      shell: bash

    - name: Debug 2
      if: ${{ env.abort_ticket_creation != 'true' }}
      run: echo "[DEBUG] - skip is OK"
      shell: bash

    - name: Debug 3
      run: |
        ls -la
        find ./ -type f -name "*esult*.json"
      shell: bash

    - name: Create Jira Issue
      if: ${{ env.abort_ticket_creation != 'true' }}
      run: |
        title="PR-${{ github.event.pull_request.number }} incident on ${{ inputs.module_name }}"
        description="This ticket relates to ${{ github.event.pull_request.title }}\n\nMore details are available in the PR-${{ github.event.pull_request.number }} logs\n\nGithub link:\n${{ github.event.pull_request.html_url }}\n"
        DATA=$( cat <<-EOF
        {"fields": {
          "summary": "${title}", "project": {"key": "MON"}, "issuetype": {"id": "10209"},
          "parent": {"id": "83818", "key": "AT-268"}, "labels": ["Veracode", "Pipeline"],
          "components":[{"name": "${{ inputs.module_name }}"}],
          "customfield_10902": {"id": "10524", "value": "DevSecOps"},
          "description": {"content": [{"content": [{"text": "${description}","type": "text"}],"type": "paragraph"}],"type": "doc","version": 1}}}
        EOF
        )

        create_ticket_ang_get_id=$( curl --request POST \
          --url "${{ inputs.jira_base_url }}/rest/api/3/issue" \
          --user "${{ inputs.jira_user_email }}:${{ inputs.jira_api_token }}" \
          --header 'Accept: application/json' \
          --header 'Content-Type: application/json' \
          --data "$DATA" | jq )
        echo "::warning::Incident ticket created as $create_ticket_ang_get_id"
      shell: bash {0}
